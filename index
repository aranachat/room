<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ú¯Ù¾ Ø¢Ø±Ø§Ù†Ø§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --bg-primary: #0e1621;
            --bg-secondary: #17212b;
            --bg-surface: #1e2c3a;
            --bg-input: #2a3942;
            --accent-primary: #2b5278;
            --accent-secondary: #4d5b9c;
            --accent-green: #00af9c;
            --text-primary: #e1e9f0;
            --text-secondary: #7c8b96;
            --text-muted: #5d6c79;
            --border-color: #2a3942;
            --message-incoming: #182533;
            --message-outgoing: #2b5278;
            --status-online: #00af9c;
            --status-offline: #7c8b96;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            --header-height: 60px;
            --input-height: 80px;
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 90vh; /* 10% Ú©Ù…ØªØ± Ø§Ø² ØµÙØ­Ù‡ */
            overflow: hidden;
            position: fixed;
            width: 100%;
            -webkit-font-smoothing: antialiased;
            padding-bottom: var(--safe-area-bottom);
        }

        /* ØµÙØ­Ø§Øª Ø§ØµÙ„ÛŒ */
        .page {
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .page.hidden {
            transform: translateX(100%);
        }

        .page.active {
            transform: translateX(0);
        }

        /* Ù‡Ø¯Ø± */
        .header {
            background: var(--bg-secondary);
            padding: 0 16px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow);
            z-index: 1000;
            position: relative;
            height: var(--header-height);
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-color);
        }

        .header-title {
            flex: 1;
            font-size: 17px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .back-btn {
            font-size: 22px;
            color: var(--accent-green);
        }

        /* Ø¢ÙˆØ§ØªØ§Ø± */
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: white;
            flex-shrink: 0;
        }

        .avatar.small {
            width: 38px;
            height: 38px;
            font-size: 16px;
        }

        /* ØµÙØ­Ù‡ Ù„Ø§Ú¯ÛŒÙ† */
        #loginPage {
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--bg-primary), #131e29);
        }

        .login-container {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 40px 30px;
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 0 20px;
            max-width: 400px;
            width: 100%;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .app-icon {
            font-size: 60px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--accent-green), #53bdeb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-label {
            display: block;
            margin-bottom: 10px;
            color: var(--text-secondary);
            text-align: center;
            font-size: 14px;
        }

        .username-input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 18px;
            text-align: center;
            transition: all 0.3s;
            font-weight: 500;
        }

        .username-input:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 2px rgba(0, 175, 156, 0.2);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--accent-green);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #009982;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 175, 156, 0.3);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            margin-top: 10px;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* ØµÙØ­Ù‡ Ù…Ø®Ø§Ø·Ø¨ÛŒÙ† */
        .search-bar {
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .search-input {
            width: 100%;
            padding: 14px 16px;
            border: none;
            border-radius: 10px;
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 15px;
            text-align: right;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent-green);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .contacts-list {
            flex: 1;
            overflow-y: auto;
            background: var(--bg-primary);
            -webkit-overflow-scrolling: touch;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            gap: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
            min-height: 70px;
        }

        .contact-item:active {
            background: var(--bg-secondary);
        }

        .contact-info {
            flex: 1;
            min-width: 0;
        }

        .contact-name {
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-last-message {
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-time {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 5px;
            text-align: left;
        }

        .contact-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--status-online);
            flex-shrink: 0;
        }

        .contact-status.offline {
            background: var(--status-offline);
        }

        /* ØµÙØ­Ù‡ Ú†Øª */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: linear-gradient(180deg, var(--bg-primary) 0%, #0c151d 100%);
            display: flex;
            flex-direction: column;
            gap: 8px;
            -webkit-overflow-scrolling: touch;
            min-height: 0;
        }

        .message-wrapper {
            max-width: 85%;
            position: relative;
            animation: messageAppear 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message-wrapper.incoming {
            align-self: flex-start;
        }

        .message-wrapper.outgoing {
            align-self: flex-end;
        }

        .message {
            padding: 10px 14px;
            border-radius: 12px;
            position: relative;
            word-wrap: break-word;
            max-width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .message.incoming {
            background: var(--message-incoming);
            border-top-right-radius: 4px;
        }

        .message.outgoing {
            border-top-left-radius: 4px;
        }

        .message-content {
            font-size: 15px;
            line-height: 1.4;
            word-break: break-word;
        }

        .message-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
            direction: ltr;
        }

        .message-time {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            opacity: 0.8;
        }

        .message-status {
            display: flex;
            gap: 2px;
        }

        .status-icon {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            transition: all 0.3s;
        }

        .status-icon.sent {
            color: #8eb5f1;
        }

        .status-icon.delivered {
            color: #8eb5f1;
        }

        .status-icon.read {
            color: var(--accent-green);
        }

        .message-sender {
            font-size: 12px;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .reply-preview {
            background: rgba(255, 255, 255, 0.05);
            border-right: 3px solid var(--accent-green);
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .reply-preview:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .reply-sender {
            font-size: 12px;
            margin-bottom: 2px;
            font-weight: 500;
        }

        .reply-content {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .reply-indicator {
            background: var(--bg-secondary);
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            display: none;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .reply-indicator-content {
            flex: 1;
            margin-left: 12px;
        }

        .reply-indicator-sender {
            font-size: 13px;
            color: var(--accent-green);
            margin-bottom: 2px;
        }

        .reply-indicator-text {
            font-size: 14px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cancel-reply {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }

        .input-area {
            background: var(--bg-secondary);
            padding: 12px 16px;
            border-top: 1px solid var(--border-color);
            position: relative;
            min-height: 80px;
            display: flex;
            align-items: flex-end;
            gap: 12px;
            transition: all 0.3s;
            flex-shrink: 0;
            margin-top: auto;
            padding-bottom: calc(12px + var(--safe-area-bottom));
        }

        .input-wrapper {
            flex: 1;
            background: var(--bg-input);
            border-radius: 20px;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            min-height: 44px;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .input-wrapper:focus-within {
            border-color: var(--accent-green);
        }

        #messageInput {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 15px;
            resize: none;
            max-height: 100px;
            min-height: 24px;
            padding: 0;
            font-family: inherit;
            line-height: 1.4;
            outline: none;
        }

        #messageInput::placeholder {
            color: var(--text-muted);
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .action-btn.attach {
            color: var(--text-secondary);
        }

        .action-btn.send {
            background: var(--accent-green);
            color: white;
            width: 44px;
            height: 44px;
        }

        .action-btn.send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--bg-input);
            color: var(--text-muted);
        }

        .action-btn.send:not(:disabled):hover {
            background: #009982;
            transform: scale(1.05);
        }

        .messages-area::-webkit-scrollbar {
            width: 6px;
        }

        .messages-area::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-area::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .contacts-list::-webkit-scrollbar {
            width: 6px;
        }

        .contacts-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .contacts-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            animation: fadeIn 0.3s;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
            animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--accent-green);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 500;
            z-index: 2000;
            animation: slideIn 0.3s, fadeOut 0.3s 2.7s;
            box-shadow: var(--shadow);
            max-width: 300px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0) translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to { opacity: 0; }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 4000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-green);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .new-contact-btn {
            position: fixed;
            bottom: 24px;
            left: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent-green);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0, 175, 156, 0.4);
            transition: all 0.3s;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .new-contact-btn:active {
            transform: scale(0.95);
        }

        .reset-btn {
            position: fixed;
            bottom: 90px;
            left: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #dc3545;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
            transition: all 0.3s;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reset-btn:active {
            transform: scale(0.95);
        }

        @media (max-width: 480px) {
            .message-wrapper {
                max-width: 90%;
            }
            
            .header {
                padding: 0 12px;
            }
            
            .input-area {
                padding: 12px;
            }
            
            .search-bar {
                padding: 12px;
            }
        }

        @media (min-width: 768px) {
            body {
                max-width: 450px;
                margin: 0 auto;
                box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
                height: 90vh;
                top: 5vh;
                border-radius: 20px;
                overflow: hidden;
                border: 1px solid var(--border-color);
            }
            
            .new-contact-btn {
                bottom: 30px;
                left: 30px;
            }
            
            .reset-btn {
                bottom: 100px;
                left: 30px;
            }
        }

        .file-message-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .file-size {
            font-size: 12px;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- ØµÙØ­Ù‡ Ù„Ø§Ú¯ÛŒÙ† -->
    <div id="loginPage" class="page active">
        <div class="login-container">
            <div class="app-icon">ğŸ’¬</div>
            <h1 style="margin-bottom: 30px; font-size: 24px;">Ú¯Ù¾ Ø¢Ø±Ø§Ù†Ø§</h1>
            
            <div class="input-group">
                <label class="input-label">Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</label>
                <input type="text" class="username-input" id="usernameInput" 
                       placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¹Ù„ÛŒØŒ Ù…Ø±ÛŒÙ…ØŒ ..." maxlength="20" autofocus>
                <small style="display: block; margin-top: 12px; color: var(--text-muted); font-size: 13px;">
                    Ø§ÛŒÙ† Ù†Ø§Ù… Ø¯Ø± Ú†Øª Ø¹Ù…ÙˆÙ…ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                </small>
            </div>
            
            <button class="btn btn-primary" onclick="initializePeer()" id="loginBtn">
                <span>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú¯Ù¾ Ø¢Ø±Ø§Ù†Ø§</span>
                <span>â†’</span>
            </button>
            
            <button class="btn btn-danger" onclick="resetAllData()">
                <span>Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù‡Ù…Ù‡ Ú†ÛŒØ²</span>
            </button>
        </div>
    </div>

    <!-- ØµÙØ­Ù‡ Ù…Ø®Ø§Ø·Ø¨ÛŒÙ† -->
    <div id="contactsPage" class="page hidden">
        <div class="header">
            <div class="header-title">Ù…Ø®Ø§Ø·Ø¨ÛŒÙ†</div>
            <div class="header-actions">
                <button class="icon-btn" onclick="toggleSearch()">ğŸ”</button>
            </div>
        </div>

        <div class="search-bar" id="searchBar" style="display: none;">
            <input type="text" class="search-input" id="searchInput" placeholder="Ø¬Ø³ØªØ¬Ùˆ..." 
                   oninput="filterContacts()" autocomplete="off">
        </div>

        <div class="contacts-list" id="contactsList">
            <!-- Ù…Ø®Ø§Ø·Ø¨ÛŒÙ† Ø§ÛŒÙ†Ø¬Ø§ Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>

        <button class="reset-btn" onclick="showResetModal()" title="Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù‡Ù…Ù‡ Ú†ÛŒØ²">
            ğŸ—‘ï¸
        </button>
        
        <button class="new-contact-btn" onclick="showNewContactModal()">+</button>
    </div>

    <!-- ØµÙØ­Ù‡ Ú†Øª -->
    <div id="chatPage" class="page hidden">
        <div class="header">
            <button class="icon-btn back-btn" onclick="goToContacts()">â†</button>
            <div class="avatar" id="chatAvatar">?</div>
            <div style="flex: 1; min-width: 0;">
                <div class="header-title" id="chatContactName">Ù…Ø®Ø§Ø·Ø¨</div>
                <div style="font-size: 13px; color: var(--text-secondary);" id="chatContactStatus">
                    <span>Ø¢ÙÙ„Ø§ÛŒÙ†</span>
                </div>
            </div>
        </div>

        <!-- Ù†ÙˆØ§Ø± Ø±ÛŒÙ¾Ù„Ø§ÛŒ -->
        <div class="reply-indicator" id="replyIndicator">
            <div class="reply-indicator-content">
                <div class="reply-indicator-sender" id="replySender">Ù¾Ø§Ø³Ø® Ø¨Ù‡:</div>
                <div class="reply-indicator-text" id="replyText"></div>
            </div>
            <button class="cancel-reply" onclick="cancelReply()">âœ•</button>
        </div>

        <div class="chat-container">
            <div class="messages-area" id="messagesArea">
                <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
            </div>

            <div class="input-area">
                <button class="action-btn attach" onclick="openFilePicker()" title="Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„">
                    ğŸ“
                </button>
                <button class="action-btn attach" onclick="openImagePicker()" title="Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³">
                    ğŸ“
                </button>
                <div class="input-wrapper">
                    <textarea id="messageInput" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." 
                              rows="1" oninput="autoResize(this)"></textarea>
                </div>
                <button class="action-btn send" onclick="sendMessage()" id="sendBtn" disabled>
                    â†‘
                </button>
            </div>
        </div>
    </div>

    <!-- Ù…Ø¯Ø§Ù„â€ŒÙ‡Ø§ -->
    <div id="newContactModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; text-align: center;">Ù…Ø®Ø§Ø·Ø¨ Ø¬Ø¯ÛŒØ¯</h2>
            <input type="text" class="username-input" id="newContactName" 
                   placeholder="Ù†Ø§Ù… Ù…Ø®Ø§Ø·Ø¨" style="margin-bottom: 16px;" autofocus>
            <small style="display: block; margin-bottom: 24px; color: var(--text-muted); text-align: center;">
                Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø®Ø§Ø·Ø¨ØŒ Ø§Ùˆ Ù†ÛŒØ² Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ù‡Ù…ÛŒÙ† Ù†Ø§Ù… ÙˆØ§Ø±Ø¯ Ú†Øª Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
            </small>
            <div style="display: flex; gap: 12px;">
                <button class="btn" onclick="closeNewContactModal()" 
                        style="background: var(--bg-surface); flex: 1;">Ù„ØºÙˆ</button>
                <button class="btn btn-primary" onclick="addNewContact()" style="flex: 1;">Ø§ÙØ²ÙˆØ¯Ù†</button>
            </div>
        </div>
    </div>

    <!-- Ù…Ø¯Ø§Ù„ ØªØ§ÛŒÛŒØ¯ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ -->
    <div id="resetModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px; text-align: center;">ØªØ§ÛŒÛŒØ¯ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ</h2>
            <p style="color: var(--text-secondary); text-align: center; margin-bottom: 24px; line-height: 1.5;">
                Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ<br>
                Ø§ÛŒÙ† Ø¹Ù…Ù„ ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø§Ø³Øª.
            </p>
            <div style="display: flex; gap: 12px;">
                <button class="btn" onclick="closeResetModal()" 
                        style="background: var(--bg-surface); flex: 1;">Ù„ØºÙˆ</button>
                <button class="btn btn-danger" onclick="confirmResetAllData()" style="flex: 1;">Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ</button>
            </div>
        </div>
    </div>

    <!-- Ù„ÙˆØ¯ÛŒÙ†Ú¯ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- ÙØ§ÛŒÙ„ Ø§ÛŒÙ†Ù¾ÙˆØª Ù…Ø®ÙÛŒ -->
    <input type="file" id="imageInput" accept="image/*" style="display: none;" 
           onchange="handleImageSelect(this.files[0])">
    <input type="file" id="fileInput" accept="*" style="display: none;" 
           onchange="handleFileSelect(this.files[0])">

    <script>
        // ==================== Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ ====================
        let peer = null;
        let myId = null;
        let myUsername = null;
        let myColor = null;
        let currentContact = null;
        let contacts = {};
        let connections = {};
        let pendingMessages = new Map();
        let replyingTo = null;
        
        const MESSAGE_STATUS = {
            SENDING: 'sending',
            SENT: 'sent',
            DELIVERED: 'delivered',
            READ: 'read'
        };
        
        const CHUNK_SIZE = 32000;
        let currentUploads = new Map();
        let receivingFiles = new Map();

        // Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ø§Ø² Ù¾ÛŒØ´ ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
        const USER_COLORS = [
            { bg: '#2b5278', text: '#ffffff' }, // Ø¢Ø¨ÛŒ
            { bg: '#00af9c', text: '#ffffff' }, // Ø³Ø¨Ø²
            { bg: '#4d5b9c', text: '#ffffff' }, // Ø¨Ù†ÙØ´
            { bg: '#c678dd', text: '#ffffff' }, // ØµÙˆØ±ØªÛŒ
            { bg: '#e5c07b', text: '#000000' }, // Ø²Ø±Ø¯
            { bg: '#98c379', text: '#000000' }, // Ø³Ø¨Ø² Ø±ÙˆØ´Ù†
            { bg: '#e06c75', text: '#ffffff' }, // Ù‚Ø±Ù…Ø²
            { bg: '#61afef', text: '#000000' }, // Ø¢Ø¨ÛŒ Ø±ÙˆØ´Ù†
            { bg: '#d19a66', text: '#000000' }, // Ù†Ø§Ø±Ù†Ø¬ÛŒ
            { bg: '#56b6c2', text: '#000000' }  // ÙÛŒØ±ÙˆØ²Ù‡â€ŒØ§ÛŒ
        ];

        // ==================== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ====================
        function initializePeer() {
            const usernameInput = document.getElementById('usernameInput').value.trim();
            
            if (!usernameInput || usernameInput.length < 2) {
                showNotification('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ù†Ø§Ù… Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø­Ø¯Ø§Ù‚Ù„ Û² Ú©Ø§Ø±Ø§Ú©ØªØ±)');
                return;
            }
            
            myUsername = usernameInput;
            
            // ØªÙˆÙ„ÛŒØ¯ Ø´Ù†Ø§Ø³Ù‡ Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ timestamp
            myId = generateUserId(myUsername);
            
            // Ø§Ù†ØªØ®Ø§Ø¨ Ø±Ù†Ú¯ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
            myColor = getColorForUser(myUsername);
            
            document.getElementById('loginBtn').disabled = true;
            showLoading('Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ...');
            
            if (typeof Peer === 'undefined') {
                loadPeerJS();
            } else {
                createPeer();
            }
        }
        
        function generateUserId(username) {
            // ØªØ±Ú©ÛŒØ¨ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ timestamp Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ù†Ø§Ø³Ù‡ Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯
            const timestamp = Date.now();
            return `${username}_${timestamp}`;
        }
        
        function getColorForUser(username) {
            // ØªÙˆÙ„ÛŒØ¯ Ø±Ù†Ú¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù‡Ø´ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            const index = Math.abs(hash) % USER_COLORS.length;
            return USER_COLORS[index];
        }
        
        function loadPeerJS() {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js';
            script.onload = createPeer;
            script.onerror = () => {
                hideLoading();
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³ÛŒØ³ØªÙ…');
                document.getElementById('loginBtn').disabled = false;
            };
            document.head.appendChild(script);
        }
        
        function createPeer() {
            peer = new Peer(myId, {
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                debug: 0,
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ]
                }
            });
            
            peer.on('open', (id) => {
                console.log('âœ… Ø³ÛŒØ³ØªÙ… Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯:', id, 'Ø¨Ø§ Ù†Ø§Ù…:', myUsername);
                loadContacts();
                showPage('contactsPage');
                hideLoading();
                showNotification(`Ø¨Ù‡ Ú¯Ù¾ Ø¢Ø±Ø§Ù†Ø§ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${myUsername}!`);
                setInterval(checkConnections, 30000);
            });
            
            peer.on('connection', (conn) => {
                handleIncomingConnection(conn);
            });
            
            peer.on('error', (err) => {
                console.error('Ø®Ø·Ø§:', err);
                if (err.type === 'unavailable-id') {
                    showNotification('Ø§ÛŒÙ† Ù†Ø§Ù… Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ØŒ Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø¯ÛŒÚ¯Ø±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                    document.getElementById('loginBtn').disabled = false;
                    hideLoading();
                }
            });
        }

        // ==================== Ù…Ø¯ÛŒØ±ÛŒØª ØµÙØ­Ø§Øª ====================
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
                setTimeout(() => page.classList.add('hidden'), 300);
            });
            
            const page = document.getElementById(pageId);
            page.classList.remove('hidden');
            setTimeout(() => {
                page.classList.add('active');
                if (pageId === 'contactsPage') {
                    renderContactsList();
                    document.getElementById('searchBar').style.display = 'none';
                } else if (pageId === 'chatPage' && currentContact) {
                    loadChatMessages();
                    setTimeout(() => {
                        document.getElementById('messageInput').focus();
                        scrollToBottom();
                    }, 100);
                }
            }, 10);
        }
        
        function goToContacts() {
            currentContact = null;
            showPage('contactsPage');
        }
        
        function toggleSearch() {
            const searchBar = document.getElementById('searchBar');
            searchBar.style.display = searchBar.style.display === 'none' ? 'block' : 'none';
            if (searchBar.style.display === 'block') {
                document.getElementById('searchInput').focus();
            }
        }
        
        function filterContacts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const contactItems = document.querySelectorAll('.contact-item');
            
            contactItems.forEach(item => {
                const name = item.querySelector('.contact-name').textContent.toLowerCase();
                
                if (name.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // ==================== Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø®Ø§Ø·Ø¨ÛŒÙ† ====================
        function loadContacts() {
            const savedContacts = localStorage.getItem(`gap_arana_contacts_${myUsername}`);
            if (savedContacts) {
                contacts = JSON.parse(savedContacts);
                Object.values(contacts).forEach(contact => {
                    contact.isOnline = false;
                    contact.messages = contact.messages || [];
                    if (!contact.color) {
                        contact.color = getColorForUser(contact.username);
                    }
                });
            }
        }
        
        function saveContacts() {
            localStorage.setItem(`gap_arana_contacts_${myUsername}`, JSON.stringify(contacts));
        }
        
        function showNewContactModal() {
            document.getElementById('newContactModal').classList.add('active');
            document.getElementById('newContactName').focus();
        }
        
        function closeNewContactModal() {
            document.getElementById('newContactModal').classList.remove('active');
            document.getElementById('newContactName').value = '';
        }
        
        function addNewContact() {
            const nameInput = document.getElementById('newContactName');
            const contactName = nameInput.value.trim();
            
            if (!contactName || contactName.length < 2) {
                showNotification('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            if (contactName === myUsername) {
                showNotification('Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø®ÙˆØ¯ØªØ§Ù† Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ù…Ø®Ø§Ø·Ø¨ Ø¨Ø§ Ø§ÛŒÙ† Ù†Ø§Ù…
            const existingContact = Object.values(contacts).find(c => c.username === contactName);
            if (existingContact) {
                showNotification('Ø§ÛŒÙ† Ù…Ø®Ø§Ø·Ø¨ Ø§Ø² Ù‚Ø¨Ù„ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯');
                return;
            }
            
            // ØªÙˆÙ„ÛŒØ¯ Ø´Ù†Ø§Ø³Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø®Ø§Ø·Ø¨
            const contactId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            contacts[contactId] = {
                id: contactId,
                username: contactName,
                lastMessage: '',
                lastMessageTime: null,
                messages: [],
                isOnline: false,
                avatar: contactName.charAt(0),
                unread: 0,
                color: getColorForUser(contactName)
            };
            
            saveContacts();
            renderContactsList();
            closeNewContactModal();
            showNotification(`Ù…Ø®Ø§Ø·Ø¨ ${contactName} Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯`);
        }
        
        function renderContactsList() {
            const container = document.getElementById('contactsList');
            
            if (Object.keys(contacts).length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;">ğŸ‘¤</div>
                        <p style="color: var(--text-secondary); margin-bottom: 10px;">Ù‡Ù†ÙˆØ² Ù…Ø®Ø§Ø·Ø¨ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</p>
                        <p style="color: var(--text-muted); font-size: 14px;">Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ + Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
                    </div>
                `;
                return;
            }
            
            const sortedContacts = Object.values(contacts).sort((a, b) => {
                return (b.lastMessageTime || 0) - (a.lastMessageTime || 0);
            });
            
            container.innerHTML = '';
            
            sortedContacts.forEach(contact => {
                const element = document.createElement('div');
                element.className = 'contact-item';
                element.onclick = () => openChat(contact);
                
                let lastMessage = 'Ø´Ø±ÙˆØ¹ Ú¯ÙØªÚ¯Ùˆ';
                let lastTime = '';
                
                if (contact.messages && contact.messages.length > 0) {
                    const lastMsg = contact.messages[contact.messages.length - 1];
                    if (lastMsg.type === 'image') {
                        lastMessage = 'ğŸ“· Ø¹Ú©Ø³';
                    } else if (lastMsg.type === 'file') {
                        lastMessage = `ğŸ“ ${lastMsg.fileName || 'ÙØ§ÛŒÙ„'}`;
                    } else {
                        lastMessage = lastMsg.content.substring(0, 30);
                        if (lastMsg.content.length > 30) lastMessage += '...';
                    }
                    
                    lastTime = formatTime(lastMsg.timestamp);
                }
                
                element.innerHTML = `
                    <div class="avatar small" style="background: ${contact.color.bg}; color: ${contact.color.text}">
                        ${contact.avatar}
                    </div>
                    <div class="contact-info">
                        <div class="contact-name" style="color: ${contact.color.bg}">${contact.username}</div>
                        <div class="contact-last-message">${lastMessage}</div>
                    </div>
                    <div style="text-align: left; min-width: 60px;">
                        <div class="contact-time">${lastTime}</div>
                        <div class="contact-status ${contact.isOnline ? '' : 'offline'}"></div>
                    </div>
                `;
                
                container.appendChild(element);
            });
        }

        // ==================== Ù…Ø¯ÛŒØ±ÛŒØª Ú†Øª Ùˆ Ø§ØªØµØ§Ù„Ø§Øª ====================
        function openChat(contact) {
            currentContact = contact;
            contact.unread = 0;
            
            document.getElementById('chatContactName').textContent = contact.username;
            document.getElementById('chatContactName').style.color = contact.color.bg;
            document.getElementById('chatAvatar').textContent = contact.avatar;
            document.getElementById('chatAvatar').style.background = contact.color.bg;
            document.getElementById('chatAvatar').style.color = contact.color.text;
            updateContactStatus();
            
            cancelReply();
            showPage('chatPage');
            
            // Ø§Ú¯Ø± Ù…Ø®Ø§Ø·Ø¨ Ø¢Ù†Ù„Ø§ÛŒÙ† Ù†ÛŒØ³ØªØŒ Ø³Ø¹ÛŒ Ø¯Ø± Ø§ØªØµØ§Ù„ Ù†Ø¯Ø§Ø±ÛŒÙ…
            // Ú†ÙˆÙ† Ø§Ú©Ù†ÙˆÙ† Ø¨Ø§ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ùˆ Ù†Ù‡ Ø´Ù…Ø§Ø±Ù‡
        }
        
        function connectToContact(contactId) {
            if (!peer || peer.disconnected) return;
            
            if (connections[contactId]) {
                connections[contactId].close();
            }
            
            const contact = contacts[contactId];
            if (!contact) return;
            
            // Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§ØªØµØ§Ù„ Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
            const conn = peer.connect(contactId, {
                reliable: true,
                serialization: 'json',
                metadata: { 
                    type: 'chat', 
                    version: '2.0',
                    username: myUsername,
                    color: myColor
                }
            });
            
            setupConnection(conn, contactId);
            connections[contactId] = conn;
        }
        
        function handleIncomingConnection(conn) {
            const contactId = conn.peer;
            const metadata = conn.metadata;
            
            if (!metadata || !metadata.username) {
                conn.close();
                return;
            }
            
            const contactUsername = metadata.username;
            const contactColor = metadata.color || getColorForUser(contactUsername);
            
            // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ù…Ø®Ø§Ø·Ø¨
            let contact = Object.values(contacts).find(c => c.username === contactUsername);
            
            if (!contact) {
                // Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø®Ø§Ø·Ø¨ Ø¬Ø¯ÛŒØ¯
                contact = {
                    id: contactId,
                    username: contactUsername,
                    messages: [],
                    isOnline: true,
                    avatar: contactUsername.charAt(0),
                    unread: 0,
                    color: contactColor
                };
                
                contacts[contactId] = contact;
                saveContacts();
            } else {
                contact.isOnline = true;
            }
            
            setupConnection(conn, contactId);
            connections[contactId] = conn;
            
            if (currentContact && currentContact.id === contactId) {
                updateContactStatus();
            }
            
            renderContactsList();
        }
        
        function setupConnection(conn, contactId) {
            conn.on('open', () => {
                console.log(`âœ… Ù…ØªØµÙ„ Ø´Ø¯ Ø¨Ù‡ ${contactId}`);
                
                const contact = contacts[contactId];
                if (contact) {
                    contact.isOnline = true;
                    if (currentContact && currentContact.id === contactId) {
                        updateContactStatus();
                    }
                }
                
                renderContactsList();
                sendDeliveryConfirmations(contactId);
            });
            
            conn.on('data', (data) => {
                handleIncomingData(data, contactId);
            });
            
            conn.on('close', () => {
                console.log(`âŒ Ø§ØªØµØ§Ù„ Ø¨Ø³ØªÙ‡ Ø´Ø¯ Ø¨Ø§ ${contactId}`);
                
                const contact = contacts[contactId];
                if (contact) {
                    contact.isOnline = false;
                    if (currentContact && currentContact.id === contactId) {
                        updateContactStatus();
                    }
                }
                
                delete connections[contactId];
                renderContactsList();
            });
            
            conn.on('error', (err) => {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„:', err);
            });
        }
        
        function updateContactStatus() {
            if (!currentContact) return;
            
            const statusEl = document.getElementById('chatContactStatus');
            const sendBtn = document.getElementById('sendBtn');
            
            if (currentContact.isOnline) {
                statusEl.innerHTML = `<span style="color: var(--status-online)">Ø¢Ù†Ù„Ø§ÛŒÙ†</span>`;
                sendBtn.disabled = false;
            } else {
                statusEl.innerHTML = `<span style="color: var(--status-offline)">Ø¢ÙÙ„Ø§ÛŒÙ†</span>`;
                sendBtn.disabled = true;
            }
        }
        
        function checkConnections() {
            Object.keys(connections).forEach(id => {
                if (connections[id].open) {
                    connections[id].send({
                        type: 'ping',
                        timestamp: Date.now(),
                        username: myUsername
                    });
                }
            });
        }

        // ==================== Ø³ÛŒØ³ØªÙ… Ø±ÛŒÙ¾Ù„Ø§ÛŒ ====================
        function setReply(message) {
            replyingTo = {
                messageId: message.messageId,
                sender: message.sender,
                content: message.content || 'ğŸ“· Ø¹Ú©Ø³',
                timestamp: message.timestamp
            };
            
            document.getElementById('replySender').textContent = `Ù¾Ø§Ø³Ø® Ø¨Ù‡ ${message.senderName || 'Ú©Ø§Ø±Ø¨Ø±'}:`;
            document.getElementById('replyText').textContent = replyingTo.content.substring(0, 50);
            document.getElementById('replyIndicator').style.display = 'flex';
            
            document.getElementById('messageInput').focus();
        }
        
        function cancelReply() {
            replyingTo = null;
            document.getElementById('replyIndicator').style.display = 'none';
        }

        // ==================== Ø§Ø±Ø³Ø§Ù„ Ùˆ Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ ====================
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !currentContact) return;
            
            const conn = connections[currentContact.id];
            if (!conn || !conn.open) {
                showNotification('Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†ÛŒØ³Øª');
                return;
            }
            
            const messageId = generateId();
            const messageData = {
                type: 'text',
                content: message,
                sender: myId,
                senderName: myUsername,
                senderColor: myColor,
                receiver: currentContact.id,
                timestamp: Date.now(),
                messageId: messageId,
                status: MESSAGE_STATUS.SENDING,
                replyTo: replyingTo ? {
                    messageId: replyingTo.messageId,
                    sender: replyingTo.sender,
                    senderName: replyingTo.senderName,
                    content: replyingTo.content
                } : null
            };
            
            saveMessageLocally(messageData);
            displayMessage(messageData, true);
            
            conn.send(messageData);
            
            pendingMessages.set(messageId, {
                data: messageData,
                retries: 0,
                delivered: false
            });
            
            input.value = '';
            autoResize(input);
            cancelReply();
            input.focus();
            
            updateContactLastMessage(currentContact.id, message, 'text');
            renderContactsList();
            checkMessageDelivery(messageId);
        }
        
        function handleIncomingData(data, senderId) {
            switch (data.type) {
                case 'text':
                case 'image':
                case 'file':
                    handleIncomingMessage(data, senderId);
                    break;
                case 'file_chunk':
                    handleFileChunk(data, senderId);
                    break;
                case 'file_start':
                    startReceivingFile(data, senderId);
                    break;
                case 'file_end':
                    completeReceivingFile(data, senderId);
                    break;
                case 'delivery_confirmation':
                    updateMessageStatus(data.messageId, MESSAGE_STATUS.DELIVERED);
                    break;
                case 'read_confirmation':
                    updateMessageStatus(data.messageId, MESSAGE_STATUS.READ);
                    break;
                case 'ping':
                    if (connections[senderId]) {
                        connections[senderId].send({
                            type: 'pong',
                            timestamp: Date.now(),
                            username: myUsername
                        });
                    }
                    break;
            }
        }
        
        function handleIncomingMessage(data, senderId) {
            // Ø§Ø±Ø³Ø§Ù„ ØªØ£ÛŒÛŒØ¯ÛŒÙ‡ ØªØ­ÙˆÛŒÙ„ Ø¨Ù‡ ÙØ±Ø³ØªÙ†Ø¯Ù‡
            if (connections[senderId]) {
                connections[senderId].send({
                    type: 'delivery_confirmation',
                    messageId: data.messageId,
                    timestamp: Date.now(),
                    sender: myId,
                    senderName: myUsername
                });
            }
            
            data.status = MESSAGE_STATUS.DELIVERED;
            
            // Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…
            setTimeout(() => {
                saveMessageLocally(data, false);
                
                if (currentContact && currentContact.id === senderId) {
                    if (data.type === 'image') {
                        displayImageMessage(data, false);
                    } else if (data.type === 'file') {
                        displayFileMessage(data, false);
                    } else {
                        displayMessage(data, false);
                    }
                    
                    setTimeout(() => {
                        if (connections[senderId]) {
                            connections[senderId].send({
                                type: 'read_confirmation',
                                messageId: data.messageId,
                                timestamp: Date.now(),
                                sender: myId,
                                senderName: myUsername
                            });
                        }
                    }, 1000);
                }
                
                const contact = contacts[senderId];
                if (contact) {
                    updateContactLastMessage(senderId, 
                        data.type === 'image' ? 'ğŸ“· Ø¹Ú©Ø³' : 
                        data.type === 'file' ? `ğŸ“ ${data.fileName}` : 
                        data.content, 
                        data.type
                    );
                }
                renderContactsList();
                
                if (!currentContact || currentContact.id !== senderId) {
                    const contact = contacts[senderId];
                    showNotification(`${contact ? contact.username : senderId}: ${data.type === 'image' ? 'ğŸ“· Ø¹Ú©Ø³ Ø¬Ø¯ÛŒØ¯' : data.type === 'file' ? `ğŸ“ ${data.fileName}` : data.content.substring(0, 30)}`);
                }
            }, 100);
        }
        
        function sendDeliveryConfirmations(contactId) {
            const contact = contacts[contactId];
            if (!contact || !contact.messages) return;
            
            const conn = connections[contactId];
            if (!conn || !conn.open) return;
            
            contact.messages.forEach(msg => {
                if (msg.sender !== myId && msg.status !== MESSAGE_STATUS.READ) {
                    conn.send({
                        type: 'read_confirmation',
                        messageId: msg.messageId,
                        timestamp: Date.now(),
                        sender: myId,
                        senderName: myUsername
                    });
                    msg.status = MESSAGE_STATUS.READ;
                }
            });
            
            saveContacts();
        }
        
        function updateMessageStatus(messageId, status) {
            const pending = pendingMessages.get(messageId);
            if (pending) {
                pending.delivered = true;
                pendingMessages.delete(messageId);
            }
            
            updateMessageStatusUI(messageId, status);
            
            if (currentContact && currentContact.messages) {
                const msgIndex = currentContact.messages.findIndex(m => m.messageId === messageId);
                if (msgIndex > -1) {
                    currentContact.messages[msgIndex].status = status;
                    saveContacts();
                }
            }
        }
        
        function checkMessageDelivery(messageId) {
            const pending = pendingMessages.get(messageId);
            if (!pending) return;
            
            if (!pending.delivered && pending.retries < 3) {
                pending.retries++;
                setTimeout(() => checkMessageDelivery(messageId), 2000);
            } else if (!pending.delivered) {
                updateMessageStatusUI(messageId, MESSAGE_STATUS.SENT);
                pendingMessages.delete(messageId);
            }
        }

        // ==================== Ø³ÛŒØ³ØªÙ… Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ ====================
        function openImagePicker() {
            document.getElementById('imageInput').click();
        }
        
        function handleImageSelect(file) {
            if (!file || !file.type.startsWith('image/')) {
                showNotification('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© ÙØ§ÛŒÙ„ Ø¹Ú©Ø³ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            if (file.size > 20 * 1024 * 1024) {
                showNotification('Ø­Ø¬Ù… Ø¹Ú©Ø³ Ø¨Ø§ÛŒØ¯ Ú©Ù…ØªØ± Ø§Ø² Û²Û° Ù…Ú¯Ø§Ø¨Ø§ÛŒØª Ø¨Ø§Ø´Ø¯');
                return;
            }
            
            showLoading('Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¹Ú©Ø³...');
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64String = e.target.result;
                
                let processedImage = base64String;
                if (file.size > 2 * 1024 * 1024) {
                    processedImage = await compressImage(base64String);
                }
                
                hideLoading();
                sendImage(processedImage, file.name);
            };
            
            reader.onerror = () => {
                hideLoading();
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„');
            };
            
            reader.readAsDataURL(file);
            document.getElementById('imageInput').value = '';
        }
        
        async function compressImage(base64String) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    let width = img.width;
                    let height = img.height;
                    const maxDimension = 1600;
                    
                    if (width > maxDimension || height > maxDimension) {
                        if (width > height) {
                            height = Math.floor(height * maxDimension / width);
                            width = maxDimension;
                        } else {
                            width = Math.floor(width * maxDimension / height);
                            height = maxDimension;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const compressedBase64 = canvas.toDataURL('image/jpeg', 0.85);
                    resolve(compressedBase64);
                };
                
                img.src = base64String;
            });
        }
        
        function sendImage(base64String, fileName) {
            if (!currentContact || !connections[currentContact.id]) {
                showNotification('Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†ÛŒØ³Øª');
                return;
            }
            
            const fileId = generateId();
            const chunks = splitBase64IntoChunks(base64String, CHUNK_SIZE);
            const totalChunks = chunks.length;
            
            const uploadInfo = {
                fileId,
                fileName,
                chunks,
                totalChunks,
                sentChunks: 0,
                base64String,
                messageId: generateId(),
                type: 'image'
            };
            
            currentUploads.set(fileId, uploadInfo);
            
            // Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ ÙØ§ÛŒÙ„
            connections[currentContact.id].send({
                type: 'file_start',
                fileId,
                fileName,
                totalChunks,
                fileType: 'image',
                sender: myId,
                senderName: myUsername,
                senderColor: myColor,
                timestamp: Date.now(),
                messageId: uploadInfo.messageId,
                replyTo: replyingTo
            });
            
            // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„
            const messageData = {
                type: 'image',
                content: base64String,
                sender: myId,
                senderName: myUsername,
                senderColor: myColor,
                timestamp: Date.now(),
                messageId: uploadInfo.messageId,
                status: MESSAGE_STATUS.SENDING,
                replyTo: replyingTo
            };
            
            saveMessageLocally(messageData);
            displayUploadProgress(fileId, 0, totalChunks, false);
            
            // Ø´Ø±ÙˆØ¹ Ø§Ø±Ø³Ø§Ù„ ØªÚ©Ù‡â€ŒÙ‡Ø§
            sendChunks(fileId);
            cancelReply();
        }

        // ==================== Ø³ÛŒØ³ØªÙ… Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„ ====================
        function openFilePicker() {
            document.getElementById('fileInput').click();
        }
        
        function handleFileSelect(file) {
            if (!file) return;
            
            if (file.size > 50 * 1024 * 1024) {
                showNotification('Ø­Ø¬Ù… ÙØ§ÛŒÙ„ Ø¨Ø§ÛŒØ¯ Ú©Ù…ØªØ± Ø§Ø² ÛµÛ° Ù…Ú¯Ø§Ø¨Ø§ÛŒØª Ø¨Ø§Ø´Ø¯');
                return;
            }
            
            showLoading(`Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ${file.name}...`);
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                hideLoading();
                
                if (file.size < 2 * 1024 * 1024) {
                    sendFileDirectly(e.target.result, file.name, file.type, file.size);
                } else {
                    sendFileChunked(e.target.result, file.name, file.type, file.size);
                }
            };
            
            reader.onerror = () => {
                hideLoading();
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„');
            };
            
            reader.readAsDataURL(file);
            document.getElementById('fileInput').value = '';
        }
        
        function sendFileDirectly(base64Data, fileName, fileType, fileSize) {
            if (!currentContact || !connections[currentContact.id]) {
                showNotification('Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†ÛŒØ³Øª');
                return;
            }
            
            const messageId = generateId();
            const messageData = {
                type: 'file',
                content: base64Data,
                fileName: fileName,
                fileType: fileType,
                fileSize: formatFileSize(fileSize),
                sender: myId,
                senderName: myUsername,
                senderColor: myColor,
                timestamp: Date.now(),
                messageId: messageId,
                status: MESSAGE_STATUS.SENDING,
                replyTo: replyingTo
            };
            
            saveMessageLocally(messageData);
            displayFileMessage(messageData, true);
            
            connections[currentContact.id].send(messageData);
            
            pendingMessages.set(messageId, {
                data: messageData,
                retries: 0,
                delivered: false
            });
            
            checkMessageDelivery(messageId);
            updateContactLastMessage(currentContact.id, `ğŸ“ ${fileName}`, 'file');
            renderContactsList();
            cancelReply();
        }
        
        function sendFileChunked(base64Data, fileName, fileType, fileSize) {
            const fileId = generateId();
            const chunks = splitBase64IntoChunks(base64Data, CHUNK_SIZE);
            const totalChunks = chunks.length;
            
            const uploadInfo = {
                fileId,
                fileName,
                fileType,
                fileSize: formatFileSize(fileSize),
                chunks,
                totalChunks,
                sentChunks: 0,
                base64Data,
                messageId: generateId(),
                type: 'file'
            };
            
            currentUploads.set(fileId, uploadInfo);
            
            connections[currentContact.id].send({
                type: 'file_start',
                fileId,
                fileName,
                fileType,
                fileSize: uploadInfo.fileSize,
                totalChunks,
                sender: myId,
                senderName: myUsername,
                senderColor: myColor,
                timestamp: Date.now(),
                messageId: uploadInfo.messageId,
                replyTo: replyingTo
            });
            
            const messageData = {
                type: 'file',
                content: null,
                fileName,
                fileType,
                fileSize: uploadInfo.fileSize,
                sender: myId,
                senderName: myUsername,
                senderColor: myColor,
                timestamp: Date.now(),
                messageId: uploadInfo.messageId,
                status: MESSAGE_STATUS.SENDING,
                replyTo: replyingTo
            };
            
            saveMessageLocally(messageData);
            displayUploadProgress(fileId, 0, totalChunks, true, fileName);
            
            sendChunks(fileId);
            cancelReply();
        }
        
        function sendChunks(fileId) {
            const uploadInfo = currentUploads.get(fileId);
            if (!uploadInfo) return;
            
            const conn = connections[currentContact.id];
            if (!conn) {
                currentUploads.delete(fileId);
                return;
            }
            
            const sendNextChunk = () => {
                if (uploadInfo.sentChunks >= uploadInfo.totalChunks) {
                    // Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§ÛŒØ§Ù† ÙØ§ÛŒÙ„
                    conn.send({
                        type: 'file_end',
                        fileId,
                        sender: myId,
                        senderName: myUsername,
                        timestamp: Date.now()
                    });
                    
                    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø­Ø§Ù„Øª Ú©Ø§Ù…Ù„
                    if (uploadInfo.type === 'image') {
                        updateMessageToImage(uploadInfo);
                    } else {
                        updateMessageToFile(uploadInfo);
                    }
                    currentUploads.delete(fileId);
                    return;
                }
                
                conn.send({
                    type: 'file_chunk',
                    fileId,
                    chunkIndex: uploadInfo.sentChunks,
                    chunkData: uploadInfo.chunks[uploadInfo.sentChunks],
                    sender: myId,
                    senderName: myUsername,
                    timestamp: Date.now()
                });
                
                uploadInfo.sentChunks++;
                
                const progress = Math.round((uploadInfo.sentChunks / uploadInfo.totalChunks) * 100);
                updateUploadProgress(fileId, progress, uploadInfo.type === 'file', uploadInfo.fileName);
                
                setTimeout(sendNextChunk, 10);
            };
            
            sendNextChunk();
        }
        
        function startReceivingFile(data, senderId) {
            const { fileId, fileName, totalChunks, fileType, messageId, replyTo, fileSize } = data;
            
            receivingFiles.set(fileId, {
                fileId,
                fileName,
                fileType,
                fileSize,
                totalChunks,
                receivedChunks: 0,
                chunks: new Array(totalChunks),
                sender: senderId,
                senderName: data.senderName,
                senderColor: data.senderColor,
                messageId,
                replyTo,
                startTime: Date.now(),
                type: fileType === 'image' ? 'image' : 'file'
            });
            
            displayDownloadProgress(fileId, 0, totalChunks, fileType === 'image', fileName);
        }
        
        function handleFileChunk(data, senderId) {
            const { fileId, chunkIndex, chunkData } = data;
            const fileInfo = receivingFiles.get(fileId);
            
            if (!fileInfo) return;
            
            fileInfo.chunks[chunkIndex] = chunkData;
            fileInfo.receivedChunks++;
            
            const progress = Math.round((fileInfo.receivedChunks / fileInfo.totalChunks) * 100);
            updateDownloadProgress(fileId, progress, fileInfo.type === 'image', fileInfo.fileName);
            
            // Ø§Ú¯Ø± Ù‡Ù…Ù‡ ØªÚ©Ù‡â€ŒÙ‡Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù†Ø¯
            if (fileInfo.receivedChunks === fileInfo.totalChunks) {
                console.log(`âœ… Ù‡Ù…Ù‡ ØªÚ©Ù‡â€ŒÙ‡Ø§ÛŒ ${fileId} Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯`);
                setTimeout(() => {
                    completeReceivingFile({ fileId }, senderId);
                }, 100);
            }
        }
        
        function completeReceivingFile(data, senderId) {
            const { fileId } = data;
            const fileInfo = receivingFiles.get(fileId);
            
            if (!fileInfo) {
                console.log(`âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§ÛŒÙ„ ${fileId} ÛŒØ§ÙØª Ù†Ø´Ø¯`);
                return;
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ù…Ù„ Ø¨ÙˆØ¯Ù† Ø¯Ø±ÛŒØ§ÙØª
            if (fileInfo.receivedChunks !== fileInfo.totalChunks) {
                console.log(`â³ Ù…Ù†ØªØ¸Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¨Ø§Ù‚ÛŒ ØªÚ©Ù‡â€ŒÙ‡Ø§: ${fileInfo.receivedChunks}/${fileInfo.totalChunks}`);
                return;
            }
            
            // ØªØ±Ú©ÛŒØ¨ ØªÙ…Ø§Ù… ØªÚ©Ù‡â€ŒÙ‡Ø§
            const base64String = fileInfo.chunks.join('');
            
            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø¯Ø§Ø¯Ù‡
            if (!base64String || base64String.length < 100) {
                console.error('Ø¯Ø§Ø¯Ù‡ Base64 Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙØ§ÛŒÙ„');
                receivingFiles.delete(fileId);
                removeProgress(fileId);
                return;
            }
            
            receivingFiles.delete(fileId);
            removeProgress(fileId);
            
            const messageData = {
                type: fileInfo.type,
                content: base64String,
                sender: fileInfo.sender,
                senderName: fileInfo.senderName,
                senderColor: fileInfo.senderColor,
                timestamp: Date.now(),
                messageId: fileInfo.messageId,
                status: MESSAGE_STATUS.DELIVERED,
                replyTo: fileInfo.replyTo,
                fileName: fileInfo.fileName,
                fileType: fileInfo.fileType,
                fileSize: fileInfo.fileSize
            };
            
            saveMessageLocally(messageData, false);
            
            if (currentContact && currentContact.id === senderId) {
                if (fileInfo.type === 'image') {
                    displayImageMessage(messageData, false);
                } else {
                    displayFileMessage(messageData, false);
                }
                scrollToBottom();
            }
            
            const contact = contacts[senderId];
            if (contact) {
                updateContactLastMessage(senderId, 
                    fileInfo.type === 'image' ? 'ğŸ“· Ø¹Ú©Ø³' : `ğŸ“ ${fileInfo.fileName}`, 
                    fileInfo.type
                );
            }
            renderContactsList();
        }

        // ==================== Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ùˆ UI ====================
        function loadChatMessages() {
            const container = document.getElementById('messagesArea');
            container.innerHTML = '';
            
            if (!currentContact || !currentContact.messages || currentContact.messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                        <p>Ø´Ø±ÙˆØ¹ Ú¯ÙØªÚ¯Ùˆ Ø¨Ø§ ${currentContact.username}</p>
                    </div>
                `;
                return;
            }
            
            currentContact.messages.forEach(msg => {
                if (msg.type === 'image') {
                    displayImageMessage(msg, msg.sender === myId, true);
                } else if (msg.type === 'file') {
                    displayFileMessage(msg, msg.sender === myId, true);
                } else {
                    displayMessage(msg, msg.sender === myId, true);
                }
            });
            
            scrollToBottom();
        }
        
        function displayMessage(messageData, isOutgoing, noAnimation = false) {
            const container = document.getElementById('messagesArea');
            
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${isOutgoing ? 'outgoing' : 'incoming'}`;
            if (noAnimation) wrapper.style.animation = 'none';
            
            wrapper.onclick = () => {
                if (!isOutgoing) {
                    setReply(messageData);
                }
            };
            
            const time = formatTime(messageData.timestamp);
            const status = getStatusIcon(messageData.status);
            
            // ØªÙ†Ø¸ÛŒÙ… Ø±Ù†Ú¯ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙØ±Ø³ØªÙ†Ø¯Ù‡
            const senderColor = messageData.senderColor || myColor;
            const textColor = senderColor.text;
            const bgColor = senderColor.bg;
            
            let replyHtml = '';
            if (messageData.replyTo) {
                replyHtml = `
                    <div class="reply-preview" onclick="scrollToMessage('${messageData.replyTo.messageId}')">
                        <div class="reply-sender" style="color: ${senderColor.bg}">
                            ${messageData.replyTo.senderName || 'Ú©Ø§Ø±Ø¨Ø±'}
                        </div>
                        <div class="reply-content">${messageData.replyTo.content}</div>
                    </div>
                `;
            }
            
            wrapper.innerHTML = `
                <div class="message ${isOutgoing ? 'outgoing' : 'incoming'}" 
                     style="${isOutgoing ? `background: ${bgColor}; color: ${textColor}` : ''}">
                    ${!isOutgoing ? `
                        <div class="message-sender" style="color: ${bgColor}">
                            ${messageData.senderName || 'Ú©Ø§Ø±Ø¨Ø±'}
                        </div>
                    ` : ''}
                    ${replyHtml}
                    <div class="message-content">${escapeHtml(messageData.content)}</div>
                    <div class="message-footer">
                        <div class="message-time" style="${isOutgoing ? `color: ${textColor}` : ''}">${time}</div>
                        ${isOutgoing ? `<div class="message-status">${status}</div>` : ''}
                    </div>
                </div>
            `;
            
            container.appendChild(wrapper);
            wrapper.setAttribute('data-message-id', messageData.messageId);
            
            if (!noAnimation) scrollToBottom();
        }
        
        function displayImageMessage(messageData, isOutgoing, noAnimation = false) {
            const container = document.getElementById('messagesArea');
            
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${isOutgoing ? 'outgoing' : 'incoming'}`;
            if (noAnimation) wrapper.style.animation = 'none';
            
            wrapper.onclick = () => {
                if (!isOutgoing) {
                    setReply(messageData);
                }
            };
            
            const time = formatTime(messageData.timestamp);
            const status = getStatusIcon(messageData.status);
            
            // ØªÙ†Ø¸ÛŒÙ… Ø±Ù†Ú¯ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙØ±Ø³ØªÙ†Ø¯Ù‡
            const senderColor = messageData.senderColor || myColor;
            const textColor = senderColor.text;
            const bgColor = senderColor.bg;
            
            let replyHtml = '';
            if (messageData.replyTo) {
                replyHtml = `
                    <div class="reply-preview" onclick="scrollToMessage('${messageData.replyTo.messageId}')">
                        <div class="reply-sender" style="color: ${senderColor.bg}">
                            ${messageData.replyTo.senderName || 'Ú©Ø§Ø±Ø¨Ø±'}
                        </div>
                        <div class="reply-content">${messageData.replyTo.content}</div>
                    </div>
                `;
            }
            
            wrapper.innerHTML = `
                <div class="message ${isOutgoing ? 'outgoing' : 'incoming'}" 
                     style="${isOutgoing ? `background: ${bgColor}; color: ${textColor}` : ''}">
                    ${!isOutgoing ? `
                        <div class="message-sender" style="color: ${bgColor}">
                            ${messageData.senderName || 'Ú©Ø§Ø±Ø¨Ø±'}
                        </div>
                    ` : ''}
                    ${replyHtml}
                    <div style="position: relative;">
                        <img src="${messageData.content}" 
                             style="max-width: 250px; border-radius: 8px; display: block; cursor: pointer;"
                             onclick="showImage('${messageData.content.replace(/'/g, "\\'")}')"
                             onload="this.style.opacity='1'"
                             style="opacity:0;transition:opacity 0.3s">
                        <div style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                            ğŸ“· Ø¹Ú©Ø³
                        </div>
                    </div>
                    <div class="message-footer">
                        <div class="message-time" style="${isOutgoing ? `color: ${textColor}` : ''}">${time}</div>
                        ${isOutgoing ? `<div class="message-status">${status}</div>` : ''}
                    </div>
                </div>
            `;
            
            container.appendChild(wrapper);
            wrapper.setAttribute('data-message-id', messageData.messageId);
            
            if (!noAnimation) scrollToBottom();
        }
        
        function displayFileMessage(messageData, isOutgoing, noAnimation = false) {
            const container = document.getElementById('messagesArea');
            
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${isOutgoing ? 'outgoing' : 'incoming'}`;
            if (noAnimation) wrapper.style.animation = 'none';
            
            const time = formatTime(messageData.timestamp);
            const status = getStatusIcon(messageData.status);
            const fileIcon = getFileIcon(messageData.fileType);
            
            // ØªÙ†Ø¸ÛŒÙ… Ø±Ù†Ú¯ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙØ±Ø³ØªÙ†Ø¯Ù‡
            const senderColor = messageData.senderColor || myColor;
            const textColor = senderColor.text;
            const bgColor = senderColor.bg;
            
            let replyHtml = '';
            if (messageData.replyTo) {
                replyHtml = `
                    <div class="reply-preview">
                        <div class="reply-sender" style="color: ${senderColor.bg}">
                            ${messageData.replyTo.senderName || 'Ú©Ø§Ø±Ø¨Ø±'}
                        </div>
                        <div class="reply-content">${messageData.replyTo.content}</div>
                    </div>
                `;
            }
            
            wrapper.innerHTML = `
                <div class="message ${isOutgoing ? 'outgoing' : 'incoming'}" 
                     style="${isOutgoing ? `background: ${bgColor}; color: ${textColor}` : ''}">
                    ${!isOutgoing ? `
                        <div class="message-sender" style="color: ${bgColor}">
                            ${messageData.senderName || 'Ú©Ø§Ø±Ø¨Ø±'}
                        </div>
                    ` : ''}
                    ${replyHtml}
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px;">
                        <div style="font-size: 24px;">${fileIcon}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; margin-bottom: 5px;">${messageData.fileName}</div>
                            <div style="font-size: 12px; ${isOutgoing ? `color: ${textColor}` : 'color: var(--text-secondary)'}">
                                ${messageData.fileSize} â€¢ ${messageData.fileType || 'ÙØ§ÛŒÙ„'}
                            </div>
                        </div>
                        <button onclick="downloadFile('${messageData.content}', '${messageData.fileName}')" 
                                style="background: ${isOutgoing ? textColor : 'var(--accent-green)'}; 
                                       color: ${isOutgoing ? bgColor : 'white'}; 
                                       border: none; border-radius: 8px; padding: 8px 12px; font-size: 12px; cursor: pointer;">
                            Ø¯Ø§Ù†Ù„ÙˆØ¯
                        </button>
                    </div>
                    <div class="message-footer">
                        <div class="message-time" style="${isOutgoing ? `color: ${textColor}` : ''}">${time}</div>
                        ${isOutgoing ? `<div class="message-status">${status}</div>` : ''}
                    </div>
                </div>
            `;
            
            container.appendChild(wrapper);
            wrapper.setAttribute('data-message-id', messageData.messageId);
            
            if (!noAnimation) scrollToBottom();
        }
        
        function displayUploadProgress(fileId, progress, totalChunks, isFile = false, fileName = '') {
            const container = document.getElementById('messagesArea');
            
            let progressEl = document.getElementById(`upload-${fileId}`);
            if (!progressEl) {
                progressEl = document.createElement('div');
                progressEl.id = `upload-${fileId}`;
                progressEl.className = 'message-wrapper outgoing';
                const icon = isFile ? 'ğŸ“' : 'ğŸ“·';
                const text = isFile ? `Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ${fileName}...` : 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³...';
                progressEl.innerHTML = `
                    <div class="message outgoing" style="background: ${myColor.bg}; color: ${myColor.text}">
                        <div class="message-content">
                            <div style="margin-bottom: 8px;">${icon} ${text}</div>
                            <div style="width: 200px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; background: ${myColor.text}; width: ${progress}%; transition: width 0.3s;"></div>
                            </div>
                            <div style="font-size: 12px; color: ${myColor.text}; text-align: center; margin-top: 4px;">
                                ${progress}%
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(progressEl);
            } else {
                const bar = progressEl.querySelector('div div');
                const text = progressEl.querySelector('div:last-child');
                if (bar) bar.style.width = `${progress}%`;
                if (text) text.textContent = `${progress}%`;
            }
            
            scrollToBottom();
        }
        
        function displayDownloadProgress(fileId, progress, totalChunks, isFile = false, fileName = '') {
            const container = document.getElementById('messagesArea');
            
            let progressEl = document.getElementById(`download-${fileId}`);
            if (!progressEl) {
                progressEl = document.createElement('div');
                progressEl.id = `download-${fileId}`;
                progressEl.className = 'message-wrapper incoming';
                const icon = isFile ? 'ğŸ“' : 'ğŸ“·';
                const text = isFile ? `Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª ${fileName}...` : 'Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¹Ú©Ø³...';
                progressEl.innerHTML = `
                    <div class="message incoming">
                        <div class="message-content">
                            <div style="margin-bottom: 8px;">${icon} ${text}</div>
                            <div style="width: 200px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; background: var(--accent-green); width: ${progress}%; transition: width 0.3s;"></div>
                            </div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.7); text-align: center; margin-top: 4px;">
                                ${progress}%
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(progressEl);
            } else {
                const bar = progressEl.querySelector('div div');
                const text = progressEl.querySelector('div:last-child');
                if (bar) bar.style.width = `${progress}%`;
                if (text) text.textContent = `${progress}%`;
            }
            
            scrollToBottom();
        }
        
        function updateUploadProgress(fileId, progress, isFile = false, fileName = '') {
            const progressEl = document.getElementById(`upload-${fileId}`);
            if (progressEl) {
                const bar = progressEl.querySelector('div div');
                const text = progressEl.querySelector('div:last-child');
                if (bar) bar.style.width = `${progress}%`;
                if (text) text.textContent = `${progress}%`;
            }
        }
        
        function updateDownloadProgress(fileId, progress, isFile = false, fileName = '') {
            const progressEl = document.getElementById(`download-${fileId}`);
            if (progressEl) {
                const bar = progressEl.querySelector('div div');
                const text = progressEl.querySelector('div:last-child');
                if (bar) bar.style.width = `${progress}%`;
                if (text) text.textContent = `${progress}%`;
            }
        }
        
        function removeProgress(fileId) {
            const uploadEl = document.getElementById(`upload-${fileId}`);
            const downloadEl = document.getElementById(`download-${fileId}`);
            if (uploadEl) uploadEl.remove();
            if (downloadEl) downloadEl.remove();
        }
        
        function updateMessageToImage(uploadInfo) {
            const progressEl = document.getElementById(`upload-${uploadInfo.fileId}`);
            if (progressEl) progressEl.remove();
            
            const messageData = {
                type: 'image',
                content: uploadInfo.base64String,
                sender: myId,
                senderName: myUsername,
                senderColor: myColor,
                timestamp: Date.now(),
                messageId: uploadInfo.messageId,
                status: MESSAGE_STATUS.SENT
            };
            
            displayImageMessage(messageData, true);
            updateContactLastMessage(currentContact.id, 'ğŸ“· Ø¹Ú©Ø³', 'image');
            renderContactsList();
        }
        
        function updateMessageToFile(uploadInfo) {
            const progressEl = document.getElementById(`upload-${uploadInfo.fileId}`);
            if (progressEl) progressEl.remove();
            
            const messageData = {
                type: 'file',
                content: uploadInfo.base64Data,
                fileName: uploadInfo.fileName,
                fileType: uploadInfo.fileType,
                fileSize: uploadInfo.fileSize,
                sender: myId,
                senderName: myUsername,
                senderColor: myColor,
                timestamp: Date.now(),
                messageId: uploadInfo.messageId,
                status: MESSAGE_STATUS.SENT
            };
            
            displayFileMessage(messageData, true);
            updateContactLastMessage(currentContact.id, `ğŸ“ ${uploadInfo.fileName}`, 'file');
            renderContactsList();
        }
        
        function updateMessageStatusUI(messageId, status) {
            const messages = document.querySelectorAll('.message-wrapper');
            messages.forEach(wrapper => {
                const messageDiv = wrapper.querySelector('.message');
                if (messageDiv && wrapper.getAttribute('data-message-id') === messageId) {
                    const statusEl = messageDiv.querySelector('.message-status');
                    if (statusEl) {
                        statusEl.innerHTML = getStatusIcon(status);
                        statusEl.style.transform = 'scale(1.2)';
                        setTimeout(() => {
                            statusEl.style.transform = 'scale(1)';
                        }, 300);
                    }
                }
            });
        }
        
        function getStatusIcon(status) {
            switch (status) {
                case MESSAGE_STATUS.SENDING:
                    return '<span class="status-icon">â†—</span>';
                case MESSAGE_STATUS.SENT:
                    return '<span class="status-icon sent">âœ“</span>';
                case MESSAGE_STATUS.DELIVERED:
                    return '<span class="status-icon delivered">âœ“âœ“</span>';
                case MESSAGE_STATUS.READ:
                    return '<span class="status-icon read">âœ“âœ“</span>';
                default:
                    return '<span class="status-icon">â†—</span>';
            }
        }
        
        function getFileIcon(fileType) {
            if (!fileType) return 'ğŸ“';
            if (fileType.includes('pdf')) return 'ğŸ“•';
            if (fileType.includes('word') || fileType.includes('document')) return 'ğŸ“„';
            if (fileType.includes('zip') || fileType.includes('rar') || fileType.includes('compressed')) return 'ğŸ“¦';
            if (fileType.includes('audio')) return 'ğŸµ';
            if (fileType.includes('video')) return 'ğŸ¬';
            return 'ğŸ“';
        }
        
        function scrollToMessage(messageId) {
            const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageEl) {
                messageEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                messageEl.style.animation = 'none';
                setTimeout(() => {
                    messageEl.style.backgroundColor = 'rgba(0, 175, 156, 0.1)';
                    setTimeout(() => {
                        messageEl.style.backgroundColor = '';
                    }, 1000);
                }, 100);
            }
        }
        
        function showImage(base64String) {
            const img = new Image();
            img.src = base64String;
            img.style.maxWidth = '90%';
            img.style.maxHeight = '90%';
            img.style.borderRadius = '8px';
            
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.right = '0';
            overlay.style.bottom = '0';
            overlay.style.background = 'rgba(0,0,0,0.9)';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            overlay.style.zIndex = '3000';
            overlay.style.cursor = 'pointer';
            
            overlay.onclick = () => overlay.remove();
            
            overlay.appendChild(img);
            document.body.appendChild(overlay);
        }
        
        function downloadFile(base64Data, fileName) {
            if (!base64Data) {
                showNotification('ÙØ§ÛŒÙ„ Ù‡Ù†ÙˆØ² Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª');
                return;
            }
            
            const link = document.createElement('a');
            link.href = base64Data;
            link.download = fileName;
            link.click();
        }

        // ==================== Helper Functions ====================
        function saveMessageLocally(messageData, isOutgoing = true) {
            if (!currentContact) return;
            
            if (!currentContact.messages) currentContact.messages = [];
            currentContact.messages.push(messageData);
            
            if (currentContact.messages.length > 1000) {
                currentContact.messages = currentContact.messages.slice(-1000);
            }
            
            saveContacts();
        }
        
        function updateContactLastMessage(contactId, message, type) {
            const contact = contacts[contactId];
            if (contact) {
                contact.lastMessage = type === 'image' ? 'ğŸ“· Ø¹Ú©Ø³' : 
                                     type === 'file' ? `ğŸ“ ${message.substring(0, 20)}` : 
                                     message;
                contact.lastMessageTime = Date.now();
                saveContacts();
            }
        }
        
        function showNotification(text) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = text;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }
        
        function showLoading(text) {
            document.getElementById('loadingOverlay').classList.add('active');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            const newHeight = Math.min(Math.max(textarea.scrollHeight, 44), 100);
            textarea.style.height = newHeight + 'px';
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = textarea.value.trim() === '' || 
                !currentContact || 
                !currentContact.isOnline;
        }
        
        function scrollToBottom() {
            const container = document.getElementById('messagesArea');
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('fa-IR', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false
            });
        }
        
        function generateId() {
            return Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        function splitBase64IntoChunks(base64String, chunkSize) {
            const chunks = [];
            for (let i = 0; i < base64String.length; i += chunkSize) {
                chunks.push(base64String.substring(i, i + chunkSize));
            }
            return chunks;
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ====================
        function showResetModal() {
            document.getElementById('resetModal').classList.add('active');
        }
        
        function closeResetModal() {
            document.getElementById('resetModal').classList.remove('active');
        }
        
        function resetAllData() {
            showResetModal();
        }
        
        function confirmResetAllData() {
            // Ø¨Ø³ØªÙ† Ù‡Ù…Ù‡ Ø§ØªØµØ§Ù„Ø§Øª
            Object.values(connections).forEach(conn => {
                conn.close();
            });
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† localStorage
            localStorage.clear();
            
            // Ø±ÛŒØ³Øª Ù…ØªØºÛŒØ±Ù‡Ø§
            peer = null;
            myId = null;
            myUsername = null;
            myColor = null;
            currentContact = null;
            contacts = {};
            connections = {};
            pendingMessages.clear();
            replyingTo = null;
            currentUploads.clear();
            receivingFiles.clear();
            
            // Ø¨Ø³ØªÙ† Ù…Ø¯Ø§Ù„
            closeResetModal();
            
            // Ø±ÙØªÙ† Ø¨Ù‡ ØµÙØ­Ù‡ Ù„Ø§Ú¯ÛŒÙ†
            showPage('loginPage');
            
            // Ø±ÛŒØ³Øª ÙØ±Ù…
            document.getElementById('usernameInput').value = '';
            document.getElementById('loginBtn').disabled = false;
            
            showNotification('Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯');
        }

        // ==================== Event Listeners ====================
        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('messageInput');
            textarea.addEventListener('input', function() {
                autoResize(this);
            });
            
            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            document.getElementById('newContactModal').addEventListener('click', function(e) {
                if (e.target === this) closeNewContactModal();
            });
            
            document.getElementById('resetModal').addEventListener('click', function(e) {
                if (e.target === this) closeResetModal();
            });
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeNewContactModal();
                    closeResetModal();
                }
            });
            
            document.getElementById('usernameInput').focus();
            
            window.addEventListener('resize', function() {
                const activeElement = document.activeElement;
                if (activeElement && (activeElement.id === 'messageInput' || activeElement.id === 'searchInput')) {
                    setTimeout(scrollToBottom, 100);
                }
            });
        });
    </script>
</body>
</html>
