<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú†Øª Ø±ÙˆÙ… Ø¹Ù…ÙˆÙ…ÛŒ</title>
    <style>
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø´Ø§Ø¨Ù‡ Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ - Ù…Ø®ØªØµØ± Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªÙ…Ø±Ú©Ø² Ø¨Ø± Ù…Ù†Ø·Ù‚ */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Vazir', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .login-page {
            padding: 40px;
            text-align: center;
        }
        
        .chat-page {
            display: none;
            height: 80vh;
            flex-direction: column;
        }
        
        .header {
            background: #4361ee;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .message {
            max-width: 80%;
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 10px;
            animation: messageAppear 0.3s;
        }
        
        .message.incoming {
            background: white;
            margin-right: auto;
            border-top-right-radius: 0;
        }
        
        .message.outgoing {
            background: #4361ee;
            color: white;
            margin-left: auto;
            border-top-left-radius: 0;
        }
        
        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #dee2e6;
            display: flex;
            gap: 10px;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #dee2e6;
            border-radius: 25px;
            font-size: 14px;
            resize: none;
        }
        
        .send-btn {
            padding: 12px 25px;
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .send-btn:hover { background: #3a56d4; }
        
        .users-list {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .user-tag {
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-dot.online { background: #4ade80; }
        .status-dot.offline { background: #dc2626; }
        
        .admin-badge {
            background: #f59e0b;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-right: 5px;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet">
</head>
<body>
    <!-- ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ -->
    <div class="container login-page" id="loginPage">
        <h1 style="margin-bottom: 20px; color: #4361ee;">Ú†Øª Ø±ÙˆÙ… Ø¹Ù…ÙˆÙ…ÛŒ</h1>
        <p style="color: #666; margin-bottom: 30px;">Ø³ÛŒØ³ØªÙ… Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</p>
        
        <input type="text" 
               id="usernameInput" 
               placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯" 
               style="width: 100%; padding: 15px; border: 1px solid #dee2e6; border-radius: 10px; font-size: 16px; margin-bottom: 20px;">
        
        <button onclick="login()" 
                id="loginBtn" 
                style="width: 100%; padding: 15px; background: #4361ee; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer;">
            ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú†Øª
        </button>
        
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #dee2e6;">
            <button onclick="resetData()" 
                    style="width: 100%; padding: 10px; background: #dc2626; color: white; border: none; border-radius: 10px; cursor: pointer;">
                Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            </button>
        </div>
    </div>
    
    <!-- ØµÙØ­Ù‡ Ú†Øª -->
    <div class="container chat-page" id="chatPage">
        <div class="header">
            <div>
                <h3 id="chatTitle">Ú†Øª Ø¹Ù…ÙˆÙ…ÛŒ</h3>
                <p id="userInfo">Ø´Ù…Ø§: <span id="myUsernameDisplay"></span></p>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span id="adminStatus"></span>
                <button onclick="refreshNetwork()" style="background: none; border: none; color: white; cursor: pointer;">
                    ğŸ”„
                </button>
            </div>
        </div>
        
        <div class="users-list" id="usersList">
            <!-- Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† -->
        </div>
        
        <div class="messages" id="messagesContainer">
            <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -->
        </div>
        
        <div class="input-area">
            <textarea id="messageInput" 
                      class="message-input" 
                      placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." 
                      rows="1" 
                      onkeydown="handleKeyPress(event)"
                      oninput="autoResize(this)"></textarea>
            <button onclick="sendMessage()" id="sendBtn" class="send-btn">Ø§Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        // ==================== Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ ====================
        let peer = null;
        let myId = null;
        let myUsername = null;
        let connections = new Map();
        let users = new Map();
        let currentAdmin = null;
        let amIAdmin = false;
        
        // ==================== ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ====================
        function generateId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString('fa-IR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function showMessage(text, type = 'info') {
            const color = type === 'error' ? '#dc2626' : type === 'success' ? '#10b981' : '#3b82f6';
            console.log(`%c${text}`, `color: ${color}; font-weight: bold;`);
        }
        
        // ==================== Ø³ÛŒØ³ØªÙ… ÙˆØ±ÙˆØ¯ Ùˆ Ø±Ù‡Ø¨Ø±ÛŒ ====================
        async function login() {
            const usernameInput = document.getElementById('usernameInput');
            const username = usernameInput.value.trim();
            
            if (!username || username.length < 2) {
                alert('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            myUsername = username;
            myId = generateId();
            
            showMessage('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ…...');
            
            // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Peer
            peer = new Peer(myId, {
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                debug: 2
            });
            
            peer.on('open', async (id) => {
                showMessage('âœ… Ø³ÛŒØ³ØªÙ… Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯');
                
                // 1. Ø§Ø¨ØªØ¯Ø§ Ø³Ø¹ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† ÙØ¹Ù„ÛŒ Ù…ØªØµÙ„ Ø´ÙˆÛŒÙ…
                await tryConnectToCurrentAdmin();
                
                // 2. Ø§Ú¯Ø± Ø§Ø¯Ù…ÛŒÙ†ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´Øª ÛŒØ§ ÙˆØµÙ„ Ù†Ø´Ø¯ÛŒÙ…ØŒ Ø®ÙˆØ¯Ù…Ø§Ù† Ø§Ø¯Ù…ÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆÛŒÙ…
                if (!currentAdmin || !connections.has('admin')) {
                    await becomeAdmin();
                }
                
                // 3. Ø«Ø¨Øª Ù†Ø§Ù… Ø¯Ø± Ø´Ø¨Ú©Ù‡
                await registerInNetwork();
                
                // Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ú†Øª
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('chatPage').style.display = 'flex';
                document.getElementById('myUsernameDisplay').textContent = myUsername;
                document.getElementById('chatTitle').textContent = `Ú†Øª Ø¹Ù…ÙˆÙ…ÛŒ (${amIAdmin ? 'Ø§Ø¯Ù…ÛŒÙ†' : 'Ø¹Ø¶Ùˆ'})`;
                document.getElementById('adminStatus').textContent = amIAdmin ? 'ğŸ›¡ï¸ Ø´Ù…Ø§ Ø§Ø¯Ù…ÛŒÙ† Ù‡Ø³ØªÛŒØ¯' : 'ğŸ‘‘ Ø§Ø¯Ù…ÛŒÙ†: ' + (currentAdmin?.username || 'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ');
                
                // Ø´Ø±ÙˆØ¹ Ù†Ø¸Ø§Ø±Øª Ø¨Ø± Ø´Ø¨Ú©Ù‡
                startNetworkMonitoring();
            });
            
            peer.on('connection', (conn) => {
                setupConnection(conn);
            });
            
            peer.on('error', (err) => {
                showMessage(`Ø®Ø·Ø§: ${err.type}`, 'error');
            });
        }
        
        async function tryConnectToCurrentAdmin() {
            showMessage('ğŸ” Ø¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§Ø¯Ù…ÛŒÙ† ÙØ¹Ù„ÛŒ...');
            
            // Ø§ÙˆÙ„ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø¯Ø± localStorage Ø¢ÛŒØ§ Ø§Ø¯Ù…ÛŒÙ† Ù‚Ø¨Ù„ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
            const savedAdmin = localStorage.getItem('chat_admin');
            if (savedAdmin) {
                const adminData = JSON.parse(savedAdmin);
                const adminPeerId = adminData.peerId;
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø¢ÛŒØ§ Ø§Ø¯Ù…ÛŒÙ† Ù‡Ù†ÙˆØ² Ø¢Ù†Ù„Ø§ÛŒÙ† Ø§Ø³ØªØŸ
                try {
                    // Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ† Ø¨ÙˆØ¯Ù† Ø§Ø¯Ù…ÛŒÙ†ØŒ ÛŒÚ© Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø®Ø§Øµ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                    const conn = peer.connect(adminPeerId, {
                        reliable: true,
                        metadata: { type: 'admin_check' }
                    });
                    
                    conn.on('open', () => {
                        showMessage('âœ… Ø§Ø¯Ù…ÛŒÙ† ÙØ¹Ù„ÛŒ Ù¾ÛŒØ¯Ø§ Ø´Ø¯ Ùˆ Ø¢Ù†Ù„Ø§ÛŒÙ† Ø§Ø³Øª');
                        currentAdmin = adminData;
                        connections.set('admin', conn);
                        setupConnection(conn);
                    });
                    
                    conn.on('error', () => {
                        showMessage('âŒ Ø§Ø¯Ù…ÛŒÙ† Ù‚Ø¨Ù„ÛŒ Ø¢ÙÙ„Ø§ÛŒÙ† Ø§Ø³Øª', 'error');
                        localStorage.removeItem('chat_admin');
                        currentAdmin = null;
                    });
                    
                    // 5 Ø«Ø§Ù†ÛŒÙ‡ Ù…Ù†ØªØ¸Ø± Ù¾Ø§Ø³Ø® Ù…ÛŒâ€ŒÙ…Ø§Ù†ÛŒÙ…
                    setTimeout(() => {
                        if (!conn.open) {
                            showMessage('â³ Ø²Ù…Ø§Ù† Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯', 'error');
                            conn.close();
                        }
                    }, 5000);
                    
                } catch (error) {
                    showMessage('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†', 'error');
                }
            } else {
                showMessage('âš ï¸ Ø§Ø¯Ù…ÛŒÙ†ÛŒ Ø¯Ø± Ø³ÛŒØ³ØªÙ… ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
            }
        }
        
        async function becomeAdmin() {
            showMessage('ğŸ‘‘ Ø¯Ø± Ø­Ø§Ù„ ØªØ¨Ø¯ÛŒÙ„ Ø´Ø¯Ù† Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ø¬Ø¯ÛŒØ¯...');
            
            amIAdmin = true;
            
            // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø± localStorage
            const adminData = {
                peerId: myId,
                username: myUsername,
                timestamp: Date.now()
            };
            
            localStorage.setItem('chat_admin', JSON.stringify(adminData));
            currentAdmin = adminData;
            
            // Ø§Ø¹Ù„Ø§Ù… Ø¨Ù‡ Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ú©Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ø¬Ø¯ÛŒØ¯ÛŒ Ø¯Ø§Ø±ÛŒÙ…
            broadcast({
                type: 'new_admin',
                adminId: myId,
                adminUsername: myUsername,
                timestamp: Date.now()
            });
            
            showMessage('âœ… Ø´Ù…Ø§ Ø§Ø¯Ù…ÛŒÙ† Ø³ÛŒØ³ØªÙ… Ø´Ø¯ÛŒØ¯', 'success');
        }
        
        async function registerInNetwork() {
            if (amIAdmin) {
                // Ø§Ú¯Ø± Ø§Ø¯Ù…ÛŒÙ† Ù‡Ø³ØªÛŒÙ…ØŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯ÛŒÚ¯Ø± Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ù…Ø§ ÙˆØµÙ„ Ø´ÙˆÙ†Ø¯
                showMessage('ğŸ“¢ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø§ØªØµØ§Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†...');
            } else {
                // Ø§Ú¯Ø± Ø¹Ø¶Ùˆ Ù‡Ø³ØªÛŒÙ…ØŒ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† ÙˆØµÙ„ Ø´ÙˆÛŒÙ… Ùˆ Ø®ÙˆØ¯ Ø±Ø§ Ù…Ø¹Ø±ÙÛŒ Ú©Ù†ÛŒÙ…
                const adminConn = connections.get('admin');
                if (adminConn && adminConn.open) {
                    adminConn.send({
                        type: 'register_user',
                        userId: myId,
                        username: myUsername,
                        timestamp: Date.now()
                    });
                    
                    showMessage('âœ… Ø«Ø¨Øª Ù†Ø§Ù… Ø¯Ø± Ø´Ø¨Ú©Ù‡ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
                }
            }
        }
        
        // ==================== Ù…Ø¯ÛŒØ±ÛŒØª Ø§ØªØµØ§Ù„Ø§Øª ====================
        function setupConnection(conn) {
            const peerId = conn.peer;
            
            conn.on('open', () => {
                showMessage(`âœ… Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯ Ø¨Ø§ ${peerId}`);
                connections.set(peerId, conn);
                
                // Ø§Ø±Ø³Ø§Ù„ Ø³Ù„Ø§Ù…
                conn.send({
                    type: 'hello',
                    from: myId,
                    username: myUsername,
                    isAdmin: amIAdmin,
                    timestamp: Date.now()
                });
            });
            
            conn.on('data', (data) => {
                handleMessage(data, peerId);
            });
            
            conn.on('close', () => {
                showMessage(`âŒ Ø§ØªØµØ§Ù„ Ø¨Ø³ØªÙ‡ Ø´Ø¯ Ø¨Ø§ ${peerId}`);
                connections.delete(peerId);
                
                // Ø§Ú¯Ø± Ø§Ø¯Ù…ÛŒÙ† Ù‚Ø·Ø¹ Ø´Ø¯
                if (currentAdmin?.peerId === peerId) {
                    handleAdminDisconnected();
                }
                
                updateUsersList();
            });
            
            conn.on('error', (err) => {
                showMessage(`Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ø§ ${peerId}: ${err}`, 'error');
            });
        }
        
        function handleMessage(data, fromPeerId) {
            switch(data.type) {
                case 'hello':
                    handleHello(data, fromPeerId);
                    break;
                case 'register_user':
                    handleUserRegistration(data, fromPeerId);
                    break;
                case 'new_admin':
                    handleNewAdmin(data, fromPeerId);
                    break;
                case 'user_list':
                    handleUserList(data, fromPeerId);
                    break;
                case 'chat_message':
                    handleChatMessage(data, fromPeerId);
                    break;
                case 'heartbeat':
                    handleHeartbeat(data, fromPeerId);
                    break;
                case 'admin_check':
                    handleAdminCheck(data, fromPeerId);
                    break;
                case 'admin_transfer':
                    handleAdminTransfer(data, fromPeerId);
                    break;
            }
        }
        
        function handleHello(data, fromPeerId) {
            // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
            users.set(fromPeerId, {
                id: data.from,
                username: data.username,
                peerId: fromPeerId,
                isAdmin: data.isAdmin,
                isOnline: true,
                lastSeen: Date.now()
            });
            
            if (data.isAdmin) {
                currentAdmin = {
                    peerId: fromPeerId,
                    username: data.username
                };
                connections.set('admin', connections.get(fromPeerId));
            }
            
            updateUsersList();
            
            // Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ø³Ù„Ø§Ù…
            const conn = connections.get(fromPeerId);
            if (conn && conn.open) {
                conn.send({
                    type: 'hello_response',
                    from: myId,
                    username: myUsername,
                    isAdmin: amIAdmin,
                    timestamp: Date.now()
                });
                
                // Ø§Ú¯Ø± Ù…Ø§ Ø§Ø¯Ù…ÛŒÙ† Ù‡Ø³ØªÛŒÙ…ØŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø±Ø§ Ø¨ÙØ±Ø³Øª
                if (amIAdmin) {
                    sendUserList(fromPeerId);
                }
            }
        }
        
        function handleUserRegistration(data, fromPeerId) {
            // ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø«Ø¨Øª Ú©Ù†Ø¯
            if (amIAdmin) {
                users.set(data.userId, {
                    id: data.userId,
                    username: data.username,
                    peerId: fromPeerId,
                    isAdmin: false,
                    isOnline: true,
                    lastSeen: Date.now()
                });
                
                showMessage(`ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯: ${data.username}`);
                
                // Ø¨Ù‡ Ù‡Ù…Ù‡ Ø§Ø¹Ù„Ø§Ù… Ú©Ù† Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡
                broadcast({
                    type: 'user_joined',
                    userId: data.userId,
                    username: data.username,
                    timestamp: Date.now()
                });
                
                // Ù„ÛŒØ³Øª Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø±Ø§ Ø¨ÙØ±Ø³Øª
                sendUserListToAll();
                updateUsersList();
            }
        }
        
        function handleNewAdmin(data, fromPeerId) {
            showMessage(`ğŸ‘‘ Ø§Ø¯Ù…ÛŒÙ† Ø¬Ø¯ÛŒØ¯: ${data.adminUsername}`);
            
            // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ù…Ø§ Ø§Ø¯Ù…ÛŒÙ† Ø¨ÙˆØ¯ÛŒÙ…ØŒ Ø¯ÛŒÚ¯Ø± Ù†ÛŒØ³ØªÛŒÙ…
            if (amIAdmin && data.adminId !== myId) {
                amIAdmin = false;
                localStorage.removeItem('chat_admin');
            }
            
            currentAdmin = {
                peerId: data.adminId,
                username: data.adminUsername
            };
            
            // Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ø¬Ø¯ÛŒØ¯ ÙˆØµÙ„ Ø´Ùˆ
            if (data.adminId !== myId && !connections.has(data.adminId)) {
                const conn = peer.connect(data.adminId, {
                    reliable: true,
                    metadata: { type: 'connect_to_admin' }
                });
                setupConnection(conn);
            }
            
            document.getElementById('adminStatus').textContent = 
                amIAdmin ? 'ğŸ›¡ï¸ Ø´Ù…Ø§ Ø§Ø¯Ù…ÛŒÙ† Ù‡Ø³ØªÛŒØ¯' : `ğŸ‘‘ Ø§Ø¯Ù…ÛŒÙ†: ${data.adminUsername}`;
            
            document.getElementById('chatTitle').textContent = 
                `Ú†Øª Ø¹Ù…ÙˆÙ…ÛŒ (${amIAdmin ? 'Ø§Ø¯Ù…ÛŒÙ†' : 'Ø¹Ø¶Ùˆ'})`;
        }
        
        function handleUserList(data, fromPeerId) {
            // Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø² Ø§Ø¯Ù…ÛŒÙ†
            data.users.forEach(user => {
                if (user.id !== myId) {
                    users.set(user.id, {
                        ...user,
                        isOnline: true,
                        lastSeen: Date.now()
                    });
                    
                    // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø³ØªØŒ Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ú©Ù†
                    if (user.isAdmin && !connections.has(user.id)) {
                        const conn = peer.connect(user.id, {
                            reliable: true,
                            metadata: { type: 'connect' }
                        });
                        setupConnection(conn);
                    }
                }
            });
            
            updateUsersList();
        }
        
        function handleChatMessage(data, fromPeerId) {
            displayMessage(data, false);
        }
        
        function handleHeartbeat(data, fromPeerId) {
            const user = users.get(fromPeerId);
            if (user) {
                user.lastSeen = Date.now();
                user.isOnline = true;
            }
            
            // Ù¾Ø§Ø³Ø® Ø¨Ù‡ heartbeat
            const conn = connections.get(fromPeerId);
            if (conn && conn.open) {
                conn.send({
                    type: 'heartbeat_response',
                    timestamp: Date.now()
                });
            }
        }
        
        function handleAdminCheck(data, fromPeerId) {
            // Ø§Ú¯Ø± Ù…Ø§ Ø§Ø¯Ù…ÛŒÙ† Ù‡Ø³ØªÛŒÙ…ØŒ Ù¾Ø§Ø³Ø® Ø¨Ø¯Ù‡
            if (amIAdmin) {
                const conn = connections.get(fromPeerId);
                if (conn && conn.open) {
                    conn.send({
                        type: 'admin_alive',
                        adminId: myId,
                        timestamp: Date.now()
                    });
                }
            }
        }
        
        function handleAdminTransfer(data, fromPeerId) {
            // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ø¯Ù…ÛŒÙ† Ø¨Ù‡ Ù…Ø§
            if (data.newAdminId === myId) {
                showMessage('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù†Ù‚Ø´ Ø§Ø¯Ù…ÛŒÙ†...');
                becomeAdmin();
            }
        }
        
        // ==================== Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¯Ù…ÛŒÙ† ====================
        function handleAdminDisconnected() {
            showMessage('âš ï¸ Ø§Ø¯Ù…ÛŒÙ† Ø³ÛŒØ³ØªÙ… Ø¢ÙÙ„Ø§ÛŒÙ† Ø´Ø¯', 'error');
            
            // Ø§Ú¯Ø± Ù…Ø§ Ø§Ø¯Ù…ÛŒÙ† Ù†ÛŒØ³ØªÛŒÙ…ØŒ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø¢ÛŒØ§ Ø¨Ø§ÛŒØ¯ Ø§Ø¯Ù…ÛŒÙ† Ø´ÙˆÛŒÙ…
            if (!amIAdmin) {
                // Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ú©Ù‡ Ø¢ÛŒØ§ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯ÛŒÚ¯Ø± Ø¢Ù†Ù„Ø§ÛŒÙ† Ù‡Ø³ØªÙ†Ø¯
                const onlineUsers = Array.from(users.values()).filter(u => u.isOnline && !u.isAdmin);
                
                // Ø§Ú¯Ø± Ù…Ø§ Ø§ÙˆÙ„ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ù„ÛŒØ³Øª Ø¨Ø§Ø´ÛŒÙ… (Ø¨Ø± Ø§Ø³Ø§Ø³ ID)ØŒ Ø§Ø¯Ù…ÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆÛŒÙ…
                const sortedUsers = onlineUsers.sort((a, b) => a.id.localeCompare(b.id));
                if (sortedUsers.length > 0 && sortedUsers[0].id === myId) {
                    setTimeout(() => {
                        showMessage('ğŸ‘‘ Ø´Ù…Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø§Ø¯Ù…ÛŒÙ† Ø¬Ø¯ÛŒØ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯ÛŒØ¯');
                        becomeAdmin();
                    }, 3000);
                }
            }
        }
        
        function sendUserList(toPeerId = null) {
            if (!amIAdmin) return;
            
            const userList = Array.from(users.values()).map(user => ({
                id: user.id,
                username: user.username,
                isAdmin: user.isAdmin
            }));
            
            const data = {
                type: 'user_list',
                users: userList,
                timestamp: Date.now()
            };
            
            if (toPeerId) {
                // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø®Ø§Øµ
                const conn = connections.get(toPeerId);
                if (conn && conn.open) {
                    conn.send(data);
                }
            } else {
                // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù‡Ù…Ù‡
                broadcast(data);
            }
        }
        
        function sendUserListToAll() {
            sendUserList();
        }
        
        function broadcast(data) {
            connections.forEach((conn, peerId) => {
                if (conn.open) {
                    conn.send(data);
                }
            });
        }
        
        // ==================== Ù†Ø¸Ø§Ø±Øª Ø¨Ø± Ø´Ø¨Ú©Ù‡ ====================
        function startNetworkMonitoring() {
            // Ø§Ø±Ø³Ø§Ù„ heartbeat Ù…Ù†Ø¸Ù…
            setInterval(() => {
                if (amIAdmin) {
                    // Ø§Ø¯Ù…ÛŒÙ† heartbeat Ù…ÛŒâ€ŒÙØ±Ø³ØªØ¯
                    broadcast({
                        type: 'heartbeat',
                        from: myId,
                        timestamp: Date.now()
                    });
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢ÙÙ„Ø§ÛŒÙ†
                    checkOfflineUsers();
                }
            }, 30000); // Ù‡Ø± 30 Ø«Ø§Ù†ÛŒÙ‡
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø³Ù„Ø§Ù…Øª Ø§Ø¯Ù…ÛŒÙ† (Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ø¶Ø§)
            if (!amIAdmin && currentAdmin) {
                setInterval(() => {
                    checkAdminHealth();
                }, 45000); // Ù‡Ø± 45 Ø«Ø§Ù†ÛŒÙ‡
            }
        }
        
        function checkOfflineUsers() {
            const now = Date.now();
            users.forEach((user, userId) => {
                if (!user.isAdmin && now - user.lastSeen > 90000) { // 90 Ø«Ø§Ù†ÛŒÙ‡
                    user.isOnline = false;
                    showMessage(`âš ï¸ Ú©Ø§Ø±Ø¨Ø± ${user.username} Ø¢ÙÙ„Ø§ÛŒÙ† Ø´Ø¯`);
                    
                    // Ø­Ø°Ù Ø§Ø² Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†
                    users.delete(userId);
                    sendUserListToAll();
                    updateUsersList();
                }
            });
        }
        
        function checkAdminHealth() {
            if (!amIAdmin && currentAdmin) {
                const adminConn = connections.get('admin');
                if (!adminConn || !adminConn.open) {
                    showMessage('ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ø³Ù„Ø§Ù…Øª Ø§Ø¯Ù…ÛŒÙ†...');
                    
                    // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø² Ø§Ø¯Ù…ÛŒÙ†
                    if (adminConn && adminConn.open) {
                        adminConn.send({
                            type: 'admin_check',
                            timestamp: Date.now()
                        });
                        
                        // Ø§Ú¯Ø± Ø¨Ø¹Ø¯ Ø§Ø² 10 Ø«Ø§Ù†ÛŒÙ‡ Ù¾Ø§Ø³Ø®ÛŒ Ù†Ø±Ø³ÛŒØ¯ØŒ Ø§Ø¯Ù…ÛŒÙ† Ù…Ø±Ø¯Ù‡ ÙØ±Ø¶ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                        setTimeout(() => {
                            if (connections.has('admin')) {
                                const currentAdminConn = connections.get('admin');
                                if (!currentAdminConn || !currentAdminConn.open) {
                                    handleAdminDisconnected();
                                }
                            }
                        }, 10000);
                    } else {
                        handleAdminDisconnected();
                    }
                }
            }
        }
        
        // ==================== Ù†Ù…Ø§ÛŒØ´ UI ====================
        function updateUsersList() {
            const container = document.getElementById('usersList');
            container.innerHTML = '';
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø®ÙˆØ¯Ù…Ø§Ù†
            const myself = document.createElement('div');
            myself.className = 'user-tag';
            myself.innerHTML = `
                <span class="status-dot online"></span>
                ${myUsername} ${amIAdmin ? '<span class="admin-badge">Ø§Ø¯Ù…ÛŒÙ†</span>' : ''}
            `;
            container.appendChild(myself);
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯ÛŒÚ¯Ø±
            users.forEach(user => {
                if (user.id !== myId) {
                    const userEl = document.createElement('div');
                    userEl.className = 'user-tag';
                    userEl.innerHTML = `
                        <span class="status-dot ${user.isOnline ? 'online' : 'offline'}"></span>
                        ${user.username} ${user.isAdmin ? '<span class="admin-badge">Ø§Ø¯Ù…ÛŒÙ†</span>' : ''}
                    `;
                    container.appendChild(userEl);
                }
            });
        }
        
        function displayMessage(data, isOutgoing) {
            const container = document.getElementById('messagesContainer');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${isOutgoing ? 'outgoing' : 'incoming'}`;
            
            messageEl.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px; ${isOutgoing ? 'color: white;' : 'color: #4361ee;'}">
                    ${data.senderName}
                </div>
                <div>${data.content}</div>
                <div style="font-size: 11px; margin-top: 5px; opacity: 0.8; text-align: left;">
                    ${formatTime(data.timestamp)}
                </div>
            `;
            
            container.appendChild(messageEl);
            container.scrollTop = container.scrollHeight;
        }
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content) return;
            
            const messageData = {
                type: 'chat_message',
                content: content,
                senderId: myId,
                senderName: myUsername,
                timestamp: Date.now()
            };
            
            // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯Ù…Ø§Ù†
            displayMessage(messageData, true);
            
            // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø¯ÛŒÚ¯Ø±Ø§Ù†
            if (amIAdmin) {
                // Ø§Ú¯Ø± Ø§Ø¯Ù…ÛŒÙ† Ù‡Ø³ØªÛŒÙ…ØŒ Ø¨Ù‡ Ù‡Ù…Ù‡ Ø¨ÙØ±Ø³Øª
                broadcast(messageData);
            } else {
                // Ø§Ú¯Ø± Ø¹Ø¶Ùˆ Ù‡Ø³ØªÛŒÙ…ØŒ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ø¨ÙØ±Ø³Øª ØªØ§ Ø§Ùˆ Ù¾Ø®Ø´ Ú©Ù†Ø¯
                const adminConn = connections.get('admin');
                if (adminConn && adminConn.open) {
                    adminConn.send(messageData);
                    
                    // Ù‡Ù…Ú†Ù†ÛŒÙ† Ø§Ø¯Ù…ÛŒÙ† Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ø±Ø§ Ø¨Ù‡ Ù‡Ù…Ù‡ Ù¾Ø®Ø´ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
                    adminConn.send({
                        type: 'broadcast_message',
                        message: messageData
                    });
                } else {
                    // Ø§Ú¯Ø± Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³ØªØŒ Ø³Ø¹ÛŒ Ú©Ù† Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯ÛŒÚ¯Ø± Ø¨ÙØ±Ø³ØªÛŒ
                    broadcast(messageData);
                }
            }
            
            input.value = '';
            autoResize(input);
        }
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        function refreshNetwork() {
            showMessage('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¨Ú©Ù‡...');
            discoverUsers();
        }
        
        function discoverUsers() {
            // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø´Ù†Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡
            users.forEach(user => {
                if (user.id !== myId && !connections.has(user.id)) {
                    const conn = peer.connect(user.id, {
                        reliable: true,
                        metadata: { type: 'discovery' }
                    });
                    setupConnection(conn);
                }
            });
        }
        
        function resetData() {
            if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.')) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>
