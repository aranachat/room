<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú†Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¬Ù‡Ø§Ù†ÛŒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazir', sans-serif;
        }
        
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --light: #f8fafc;
            --dark: #1e293b;
            --gray: #64748b;
            --public-chat: #3b82f6;
            --private-chat: #8b5cf6;
        }
        
        body {
            background: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0,0,0,0.4);
            height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            background: var(--dark);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .user-status {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .status-badge {
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }
        
        /* Main Layout */
        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* Sidebar */
        .sidebar {
            width: 300px;
            background: var(--light);
            border-left: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-type-selector {
            display: flex;
            background: white;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .chat-type-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            position: relative;
            color: var(--gray);
        }
        
        .chat-type-btn.active {
            color: var(--primary);
        }
        
        .chat-type-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            left: 0;
            height: 3px;
            background: var(--primary);
        }
        
        .chat-type-btn:hover:not(.active) {
            background: #f1f5f9;
        }
        
        /* Users List */
        .users-section {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .section-title h3 {
            color: var(--dark);
            font-size: 16px;
        }
        
        .users-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: white;
            border-radius: 12px;
            border: 2px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .user-item:hover {
            border-color: var(--primary);
            transform: translateX(-5px);
        }
        
        .user-item.active {
            border-color: var(--primary);
            background: #eff6ff;
        }
        
        .user-item.private {
            border-color: var(--private-chat);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--dark);
            margin-bottom: 2px;
        }
        
        .user-status-text {
            font-size: 11px;
            color: var(--gray);
        }
        
        .user-badges {
            display: flex;
            gap: 4px;
        }
        
        .badge {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            color: white;
        }
        
        .badge.leader {
            background: var(--warning);
        }
        
        .badge.online {
            background: var(--success);
        }
        
        .badge.private {
            background: var(--private-chat);
        }
        
        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8fafc;
        }
        
        .chat-header {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-title {
            font-size: 18px;
            color: var(--dark);
        }
        
        .chat-info {
            font-size: 12px;
            color: var(--gray);
        }
        
        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        /* Messages */
        .message {
            max-width: 65%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            animation: slideIn 0.3s ease;
            word-break: break-word;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.incoming {
            background: white;
            align-self: flex-start;
            border-bottom-right-radius: 5px;
        }
        
        .message.outgoing {
            background: var(--primary);
            color: white;
            align-self: flex-end;
            border-bottom-left-radius: 5px;
        }
        
        .message.private {
            background: var(--private-chat);
        }
        
        .message.system {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            color: var(--dark);
            align-self: center;
            max-width: 80%;
            text-align: center;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .message-sender {
            font-size: 12px;
            font-weight: 500;
        }
        
        .message-time {
            font-size: 11px;
            opacity: 0.8;
        }
        
        .message-content {
            line-height: 1.5;
            font-size: 14px;
        }
        
        .message-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 5px;
        }
        
        .message-status {
            font-size: 10px;
            opacity: 0.8;
        }
        
        /* Input Area */
        .input-area {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 14px;
            resize: none;
            outline: none;
            transition: border 0.3s;
            line-height: 1.5;
        }
        
        .message-input:focus {
            border-color: var(--primary);
        }
        
        .send-btn {
            padding: 12px 25px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .send-btn:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Login Page */
        .login-page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #1e3a8a 0%, #312e81 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        .login-icon {
            font-size: 48px;
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .login-title {
            color: var(--dark);
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            color: var(--gray);
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .login-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            text-align: center;
            outline: none;
            transition: border 0.3s;
        }
        
        .login-input:focus {
            border-color: var(--primary);
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            margin: 20px 0;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .login-btn:hover {
            background: var(--primary-dark);
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1001;
            animation: notificationIn 0.3s ease;
            border-right: 4px solid var(--primary);
        }
        
        @keyframes notificationIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification.success {
            border-color: var(--success);
        }
        
        .notification.error {
            border-color: var(--danger);
        }
        
        .notification.warning {
            border-color: var(--warning);
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e2e8f0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Private Chat Badge */
        .private-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--private-chat);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Login Page -->
    <div class="login-page" id="loginPage">
        <div class="login-card">
            <div class="login-icon">ğŸ’¬</div>
            <h1 class="login-title">Ú†Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¬Ù‡Ø§Ù†ÛŒ</h1>
            <p class="login-subtitle">Ø§ØªØ§Ù‚ ÙˆØ§Ø­Ø¯ â€¢ Ø±Ù‡Ø¨Ø±ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± â€¢ Ú†Øª Ø®ØµÙˆØµÛŒ Ø§Ù…Ù†</p>
            
            <input type="text" 
                   class="login-input" 
                   id="usernameInput" 
                   placeholder="Ù†Ø§Ù… Ù‚Ø§Ø¨Ù„ Ù†Ù…Ø§ÛŒØ´ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"
                   maxlength="20"
                   autocomplete="off">
            
            <div style="margin: 20px 0; padding: 15px; background: #f8fafc; border-radius: 10px; text-align: right;">
                <h4 style="color: var(--dark); margin-bottom: 10px; font-size: 14px;">ğŸ¯ Ù†Ø­ÙˆÙ‡ Ú©Ø§Ø± Ø³ÛŒØ³ØªÙ…:</h4>
                <p style="color: var(--gray); font-size: 12px; line-height: 1.6; margin-bottom: 10px;">
                    â€¢ Ù‡Ù…Ù‡ Ø¯Ø± ÛŒÚ© Ø§ØªØ§Ù‚ Ø¬Ù‡Ø§Ù†ÛŒ ÙˆØ§Ø­Ø¯ Ù‡Ø³ØªÙ†Ø¯<br>
                    â€¢ Ø³ÛŒØ³ØªÙ… Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø±Ù‡Ø¨Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÛŒâ€ŒÚ©Ù†Ø¯<br>
                    â€¢ Ø§Ù…Ú©Ø§Ù† Ú†Øª Ø®ØµÙˆØµÛŒ Ø§Ù…Ù† Ø¨ÛŒÙ† Ù‡Ø± Ø¯Ùˆ Ú©Ø§Ø±Ø¨Ø±<br>
                    â€¢ Ø¹Ø¯Ù… Ù†ÛŒØ§Ø² Ø¨Ù‡ Ú©Ø¯ Ø§ØªØ§Ù‚ ÛŒØ§ Ø«Ø¨Øª Ù†Ø§Ù…
                </p>
            </div>
            
            <button class="login-btn" id="loginBtn" onclick="login()">
                <span id="loginBtnText">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú†Øª Ø¬Ù‡Ø§Ù†ÛŒ</span>
            </button>
            
            <div style="margin-top: 20px; font-size: 12px; color: var(--gray);">
                <p>Ø§ØªØ§Ù‚ ÙˆØ§Ø­Ø¯ â€¢ Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª â€¢ Ø±Ø§ÛŒÚ¯Ø§Ù†</p>
            </div>
        </div>
    </div>
    
    <!-- Main Chat -->
    <div class="container" id="chatContainer" style="display: none;">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-globe"></i>
                <span>Ú†Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¬Ù‡Ø§Ù†ÛŒ</span>
            </div>
            
            <div class="user-status">
                <div class="status-badge">
                    <span class="status-dot"></span>
                    <span id="connectionStatus">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...</span>
                </div>
                <div class="status-badge" id="leaderStatus">
                    <i class="fas fa-crown"></i>
                    <span id="leaderText">Ø±Ù‡Ø¨Ø±: ...</span>
                </div>
                <div class="status-badge">
                    <i class="fas fa-users"></i>
                    <span id="userCount">0</span> Ú©Ø§Ø±Ø¨Ø±
                </div>
            </div>
        </div>
        
        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Chat Type Selector -->
                <div class="chat-type-selector">
                    <button class="chat-type-btn active" onclick="switchChatType('public')">
                        <i class="fas fa-users"></i> Ú†Øª Ø¹Ù…ÙˆÙ…ÛŒ
                    </button>
                    <button class="chat-type-btn" onclick="switchChatType('private')">
                        <i class="fas fa-lock"></i> Ú†Øª Ø®ØµÙˆØµÛŒ
                    </button>
                </div>
                
                <!-- Public Users List -->
                <div class="users-section" id="publicUsersSection">
                    <div class="section-title">
                        <h3>ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†</h3>
                        <span class="badge online" id="onlineCount">0</span>
                    </div>
                    <div class="users-list" id="publicUsersList">
                        <!-- Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¹Ù…ÙˆÙ…ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                    </div>
                </div>
                
                <!-- Private Chats List -->
                <div class="users-section" id="privateUsersSection" style="display: none;">
                    <div class="section-title">
                        <h3>ğŸ”’ Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ø®ØµÙˆØµÛŒ</h3>
                    </div>
                    <div class="users-list" id="privateUsersList">
                        <!-- Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ø®ØµÙˆØµÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                    </div>
                </div>
                
                <!-- System Controls -->
                <div style="padding: 15px; margin-top: auto; border-top: 1px solid #e2e8f0;">
                    <button onclick="refreshNetwork()" 
                            style="width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 10px; cursor: pointer; margin-bottom: 10px;">
                        <i class="fas fa-sync-alt"></i> Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¨Ú©Ù‡
                    </button>
                    <button onclick="leaveChat()" 
                            style="width: 100%; padding: 10px; background: var(--danger); color: white; border: none; border-radius: 10px; cursor: pointer;">
                        <i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬ Ø§Ø² Ú†Øª
                    </button>
                </div>
            </div>
            
            <!-- Chat Area -->
            <div class="chat-area">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div>
                        <div class="chat-title" id="chatTitle">ğŸ’¬ Ú†Øª Ø¹Ù…ÙˆÙ…ÛŒ Ø¬Ù‡Ø§Ù†ÛŒ</div>
                        <div class="chat-info" id="chatInfo">Ù‡Ù…Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯</div>
                    </div>
                </div>
                
                <!-- Messages Container -->
                <div class="messages-container" id="messagesContainer">
                    <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                    <div class="empty-state" id="emptyState">
                        <i class="fas fa-comments"></i>
                        <p>Ù‡Ù†ÙˆØ² Ù¾ÛŒØ§Ù…ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ú†Øª Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
                        <p style="font-size: 12px; margin-top: 10px;">Ø§ÙˆÙ„ÛŒÙ† Ù¾ÛŒØ§Ù… Ø±Ø§ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯!</p>
                    </div>
                </div>
                
                <!-- Input Area -->
                <div class="input-area">
                    <textarea id="messageInput" 
                              class="message-input" 
                              placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." 
                              rows="1"
                              onkeydown="handleKeyPress(event)"
                              oninput="autoResize(this)"></textarea>
                    <button onclick="sendMessage()" id="sendBtn" class="send-btn">Ø§Ø±Ø³Ø§Ù„</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        // ==================== Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ ====================
        let peer = null;
        let myVisibleName = '';
        let myHiddenName = '';
        let myPeerId = '';
        let currentLeaderId = '';
        let amILeader = false;
        
        let connections = new Map(); // Ù‡Ù…Ù‡ Ø§ØªØµØ§Ù„Ø§Øª
        let users = new Map(); // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
        let privateChats = new Map(); // Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ø®ØµÙˆØµÛŒ ÙØ¹Ø§Ù„
        let pendingMessages = new Map(); // Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„
        
        let currentChatType = 'public'; // 'public' ÛŒØ§ 'private'
        let currentPrivateChat = null; // Ø´Ù†Ø§Ø³Ù‡ Ú†Øª Ø®ØµÙˆØµÛŒ ÙØ¹Ù„ÛŒ
        
        const GLOBAL_ROOM = 'GLOBAL_CHAT_ROOM';
        const LEADER_PREFIX = 'leader_';
        const MAX_RETRY_NAMES = 100;
        
        let heartbeatInterval = null;
        let leaderCheckInterval = null;
        
        // ==================== ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ====================
        function generateHiddenName() {
            // ØªÙˆÙ„ÛŒØ¯ ÛŒÚ© Ù†Ø§Ù… Ù¾Ù†Ù‡Ø§Ù† ØªØµØ§Ø¯ÙÛŒ (Ù…Ø§Ù†Ù†Ø¯ leader_abc123)
            const randomStr = Math.random().toString(36).substr(2, 8);
            return LEADER_PREFIX + randomStr;
        }
        
        function generatePeerId() {
            // Ø´Ù†Ø§Ø³Ù‡ Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ú©Ø§Ø±Ø¨Ø±
            return `${GLOBAL_ROOM}_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            let icon = 'â„¹ï¸';
            if (type === 'success') icon = 'âœ…';
            if (type === 'error') icon = 'âŒ';
            if (type === 'warning') icon = 'âš ï¸';
            
            notification.innerHTML = `
                <span>${icon}</span>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'notificationIn 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString('fa-IR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ==================== Ø³ÛŒØ³ØªÙ… Ù„Ø§Ú¯ÛŒÙ† ====================
        async function login() {
            const usernameInput = document.getElementById('usernameInput');
            myVisibleName = usernameInput.value.trim();
            
            if (!myVisibleName || myVisibleName.length < 2) {
                showNotification('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø­Ø¯Ø§Ù‚Ù„ Û² Ú©Ø§Ø±Ø§Ú©ØªØ±)', 'error');
                return;
            }
            
            if (myVisibleName.length > 20) {
                showNotification('Ù†Ø§Ù… Ù†Ø¨Ø§ÛŒØ¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² Û²Û° Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯', 'error');
                return;
            }
            
            // Ø°Ø®ÛŒØ±Ù‡ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ
            localStorage.setItem('chat_username', myVisibleName);
            
            // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ ÙˆØ±ÙˆØ¯
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<div class="loading"></div> Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...';
            
            showNotification('ğŸ” Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø´Ø¨Ú©Ù‡ Ø¬Ù‡Ø§Ù†ÛŒ...', 'info');
            
            // Ù…Ø±Ø­Ù„Ù‡ Û±: Ú©Ø´Ù Ø±Ù‡Ø¨Ø± ÙØ¹Ù„ÛŒ
            await discoverCurrentLeader();
        }
        
        async function discoverCurrentLeader() {
            showNotification('ğŸ‘‘ Ø¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ Ø±Ù‡Ø¨Ø± ÙØ¹Ù„ÛŒ...', 'info');
            
            // Ø§Ø¨ØªØ¯Ø§ Ø¨Ø±Ø±Ø³ÛŒ localStorage Ø¨Ø±Ø§ÛŒ Ø±Ù‡Ø¨Ø± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
            const savedLeader = localStorage.getItem('global_leader');
            let leaderFound = false;
            
            if (savedLeader) {
                try {
                    const leaderData = JSON.parse(savedLeader);
                    const leaderPeerId = leaderData.peerId;
                    
                    // ØªØ³Øª Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø±Ù‡Ø¨Ø± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
                    if (await testLeaderConnection(leaderPeerId)) {
                        currentLeaderId = leaderPeerId;
                        leaderFound = true;
                        showNotification(`âœ… Ø±Ù‡Ø¨Ø± ÙØ¹Ù„ÛŒ Ù¾ÛŒØ¯Ø§ Ø´Ø¯: ${leaderData.visibleName}`, 'success');
                    }
                } catch (error) {
                    console.log('Ø±Ù‡Ø¨Ø± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª:', error);
                }
            }
            
            if (!leaderFound) {
                showNotification('Ø±Ù‡Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ ØªØ¨Ø¯ÛŒÙ„ Ø´Ø¯Ù† Ø¨Ù‡ Ø±Ù‡Ø¨Ø± Ø¬Ø¯ÛŒØ¯...', 'warning');
                amILeader = true;
                myHiddenName = generateHiddenName();
                currentLeaderId = '';
            } else {
                amILeader = false;
                // ØªÙˆÙ„ÛŒØ¯ Ù†Ø§Ù… Ù¾Ù†Ù‡Ø§Ù† Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ¯Ù…Ø§Ù†
                myHiddenName = generateHiddenName();
            }
            
            // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Peer
            await initializePeer();
        }
        
        async function testLeaderConnection(leaderPeerId) {
            return new Promise((resolve) => {
                // Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Peer Ù…ÙˆÙ‚Øª Ø¨Ø±Ø§ÛŒ ØªØ³Øª
                const tempPeer = new Peer(`test_${Date.now()}`, {
                    host: '0.peerjs.com',
                    port: 443,
                    path: '/',
                    debug: 0
                });
                
                tempPeer.on('open', () => {
                    const conn = tempPeer.connect(leaderPeerId, {
                        reliable: true,
                        metadata: { type: 'leader_test' }
                    });
                    
                    conn.on('open', () => {
                        // Ø±Ù‡Ø¨Ø± Ø¢Ù†Ù„Ø§ÛŒÙ† Ø§Ø³Øª
                        conn.close();
                        tempPeer.destroy();
                        resolve(true);
                    });
                    
                    conn.on('error', () => {
                        conn.close();
                        tempPeer.destroy();
                        resolve(false);
                    });
                    
                    setTimeout(() => {
                        conn.close();
                        tempPeer.destroy();
                        resolve(false);
                    }, 3000);
                });
                
                tempPeer.on('error', () => {
                    tempPeer.destroy();
                    resolve(false);
                });
            });
        }
        
        // ==================== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Peer ====================
        async function initializePeer() {
            myPeerId = generatePeerId();
            
            try {
                // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ Ø§ØµÙ„ÛŒ
                peer = new Peer(myPeerId, {
                    host: '0.peerjs.com',
                    port: 443,
                    path: '/',
                    debug: 0,
                    config: {
                        'iceServers': [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    }
                });
                
                peer.on('open', async (id) => {
                    console.log('âœ… Peer Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯:', id);
                    
                    // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®ÙˆØ¯Ù…Ø§Ù†
                    users.set(myPeerId, {
                        peerId: myPeerId,
                        visibleName: myVisibleName,
                        hiddenName: myHiddenName,
                        isLeader: amILeader,
                        isOnline: true,
                        lastSeen: Date.now(),
                        isMe: true
                    });
                    
                    // Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('chatContainer').style.display = 'flex';
                    
                    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI
                    updateUI();
                    
                    // Ø´Ø±ÙˆØ¹ Ø³ÛŒØ³ØªÙ…
                    if (amILeader) {
                        await setupAsLeader();
                    } else {
                        await setupAsMember();
                    }
                    
                    // Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ø§ØªØµØ§Ù„Ø§Øª ÙˆØ±ÙˆØ¯ÛŒ
                    listenForIncomingConnections();
                    
                    // Ø´Ø±ÙˆØ¹ Ø³ÛŒØ³ØªÙ… heartbeat
                    startHeartbeatSystem();
                    
                    showNotification(`Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${myVisibleName}!`, 'success');
                });
                
                peer.on('error', async (err) => {
                    console.error('Ø®Ø·Ø§ÛŒ Peer:', err);
                    
                    if (err.type === 'unavailable-id') {
                        // Ø´Ù†Ø§Ø³Ù‡ ØªÚ©Ø±Ø§Ø±ÛŒ - ÛŒÚ© Ø´Ù†Ø§Ø³Ù‡ Ø¬Ø¯ÛŒØ¯ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†
                        showNotification('Ø´Ù†Ø§Ø³Ù‡ ØªÚ©Ø±Ø§Ø±ÛŒØŒ Ø¯Ø± Ø­Ø§Ù„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯...', 'warning');
                        myPeerId = generatePeerId();
                        setTimeout(() => initializePeer(), 1000);
                    } else {
                        showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø´Ø¨Ú©Ù‡', 'error');
                        document.getElementById('loginBtn').disabled = false;
                        document.getElementById('loginBtnText').textContent = 'ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯';
                    }
                });
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Peer:', error);
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ…', 'error');
                document.getElementById('loginBtn').disabled = false;
                document.getElementById('loginBtnText').textContent = 'ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯';
            }
        }
        
        async function setupAsLeader() {
            console.log('ğŸ‘‘ ØªÙ†Ø¸ÛŒÙ… Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø±Ù‡Ø¨Ø±');
            
            // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ù‡Ø¨Ø± Ø¯Ø± localStorage
            const leaderData = {
                peerId: myPeerId,
                visibleName: myVisibleName,
                hiddenName: myHiddenName,
                timestamp: Date.now()
            };
            
            localStorage.setItem('global_leader', JSON.stringify(leaderData));
            currentLeaderId = myPeerId;
            
            // Ø´Ø±ÙˆØ¹ Ø³ÛŒØ³ØªÙ… Ú©Ø´Ù Ø¨Ø±Ø§ÛŒ Ø±Ù‡Ø¨Ø±
            startLeaderDiscovery();
            
            showNotification('Ø´Ù…Ø§ Ø±Ù‡Ø¨Ø± Ø´Ø¨Ú©Ù‡ Ø´Ø¯ÛŒØ¯!', 'success');
        }
        
        async function setupAsMember() {
            console.log('ğŸ‘¤ ØªÙ†Ø¸ÛŒÙ… Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø¹Ø¶Ùˆ');
            
            // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø±Ù‡Ø¨Ø±
            await connectToLeader();
        }
        
        async function connectToLeader() {
            if (!currentLeaderId || currentLeaderId === myPeerId) {
                return;
            }
            
            showNotification(`Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø±Ù‡Ø¨Ø±...`, 'info');
            
            try {
                const conn = peer.connect(currentLeaderId, {
                    reliable: true,
                    metadata: {
                        type: 'member_join',
                        visibleName: myVisibleName,
                        hiddenName: myHiddenName,
                        peerId: myPeerId
                    }
                });
                
                conn.on('open', () => {
                    console.log('âœ… Ø¨Ù‡ Ø±Ù‡Ø¨Ø± Ù…ØªØµÙ„ Ø´Ø¯ÛŒÙ…');
                    
                    connections.set(currentLeaderId, conn);
                    setupConnectionListeners(conn, currentLeaderId);
                    
                    // Ù…Ø¹Ø±ÙÛŒ Ø®ÙˆØ¯ Ø¨Ù‡ Ø±Ù‡Ø¨Ø±
                    conn.send({
                        type: 'register',
                        peerId: myPeerId,
                        visibleName: myVisibleName,
                        hiddenName: myHiddenName,
                        timestamp: Date.now()
                    });
                    
                    showNotification('Ø¨Ù‡ Ø´Ø¨Ú©Ù‡ Ø¬Ù‡Ø§Ù†ÛŒ Ù…ØªØµÙ„ Ø´Ø¯ÛŒØ¯', 'success');
                });
                
                conn.on('error', (err) => {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø±Ù‡Ø¨Ø±:', err);
                    
                    // Ø±Ù‡Ø¨Ø± Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¢ÙÙ„Ø§ÛŒÙ† Ø¨Ø§Ø´Ø¯ - Ù…Ø§ Ù…ÛŒâ€ŒØ´ÙˆÛŒÙ… Ø±Ù‡Ø¨Ø± Ø¬Ø¯ÛŒØ¯
                    if (!amILeader) {
                        setTimeout(() => {
                            showNotification('Ø±Ù‡Ø¨Ø± Ø¢ÙÙ„Ø§ÛŒÙ† Ø§Ø³Øª. ØªØ¨Ø¯ÛŒÙ„ Ø´Ø¯Ù† Ø¨Ù‡ Ø±Ù‡Ø¨Ø± Ø¬Ø¯ÛŒØ¯...', 'warning');
                            amILeader = true;
                            currentLeaderId = myPeerId;
                            setupAsLeader();
                        }, 5000);
                    }
                });
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø±Ù‡Ø¨Ø±:', error);
            }
        }
        
        // ==================== Ù…Ø¯ÛŒØ±ÛŒØª Ø§ØªØµØ§Ù„Ø§Øª ====================
        function listenForIncomingConnections() {
            peer.on('connection', (conn) => {
                console.log('ğŸ”— Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§ØªØµØ§Ù„ Ø§Ø²:', conn.peer);
                
                const peerId = conn.peer;
                connections.set(peerId, conn);
                setupConnectionListeners(conn, peerId);
                
                // Ø§Ú¯Ø± Ø±Ù‡Ø¨Ø± Ù‡Ø³ØªÛŒÙ…ØŒ Ø§ØªØµØ§Ù„ Ø±Ø§ Ø¨Ù¾Ø°ÛŒØ± Ùˆ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø«Ø¨Øª Ú©Ù†
                if (amILeader) {
                    conn.on('open', () => {
                        showNotification('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§ØªØµØ§Ù„ Ø¬Ø¯ÛŒØ¯ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯', 'info');
                    });
                }
            });
        }
        
        function setupConnectionListeners(conn, peerId) {
            conn.on('data', (data) => {
                handleIncomingData(data, peerId);
            });
            
            conn.on('close', () => {
                console.log('âŒ Ø§ØªØµØ§Ù„ Ø¨Ø³ØªÙ‡ Ø´Ø¯ Ø¨Ø§:', peerId);
                connections.delete(peerId);
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±
                const user = users.get(peerId);
                if (user) {
                    user.isOnline = false;
                    
                    // Ø§Ú¯Ø± Ø±Ù‡Ø¨Ø± Ø¢ÙÙ„Ø§ÛŒÙ† Ø´Ø¯
                    if (user.isLeader && peerId === currentLeaderId && !amILeader) {
                        handleLeaderDisconnected();
                    }
                    
                    updateUsersList();
                }
            });
            
            conn.on('error', (err) => {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„:', peerId, err);
                connections.delete(peerId);
                
                const user = users.get(peerId);
                if (user) {
                    user.isOnline = false;
                    updateUsersList();
                }
            });
        }
        
        function handleLeaderDisconnected() {
            showNotification('âš ï¸ Ø±Ù‡Ø¨Ø± Ø´Ø¨Ú©Ù‡ Ø¢ÙÙ„Ø§ÛŒÙ† Ø´Ø¯', 'warning');
            
            // ØµØ¨Ø± Ú©Ù† Ùˆ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù† Ú©Ù‡ Ø¢ÛŒØ§ Ø±Ù‡Ø¨Ø± Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø¯
            setTimeout(async () => {
                if (!amILeader) {
                    // ØªØ³Øª Ù…Ø¬Ø¯Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø±Ù‡Ø¨Ø±
                    const leaderUser = users.get(currentLeaderId);
                    if (leaderUser && !leaderUser.isOnline) {
                        // ØªØ¨Ø¯ÛŒÙ„ Ø´Ø¯Ù† Ø¨Ù‡ Ø±Ù‡Ø¨Ø± Ø¬Ø¯ÛŒØ¯
                        showNotification('ØªØ¨Ø¯ÛŒÙ„ Ø´Ø¯Ù† Ø¨Ù‡ Ø±Ù‡Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø´Ø¨Ú©Ù‡...', 'info');
                        amILeader = true;
                        currentLeaderId = myPeerId;
                        await setupAsLeader();
                        
                        // Ø§Ø¹Ù„Ø§Ù… Ø¨Ù‡ Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
                        broadcastToAll({
                            type: 'new_leader',
                            leaderId: myPeerId,
                            leaderName: myVisibleName,
                            timestamp: Date.now()
                        });
                    }
                }
            }, 10000);
        }
        
        // ==================== Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ ====================
        function handleIncomingData(data, fromPeerId) {
            // console.log('ğŸ“© Ø¯Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØªÛŒ:', data.type, 'Ø§Ø²:', fromPeerId);
            
            switch(data.type) {
                case 'register':
                    handleUserRegistration(data, fromPeerId);
                    break;
                case 'public_message':
                    handlePublicMessage(data, fromPeerId);
                    break;
                case 'private_message':
                    handlePrivateMessage(data, fromPeerId);
                    break;
                case 'user_list':
                    handleUserList(data, fromPeerId);
                    break;
                case 'heartbeat':
                    handleHeartbeat(data, fromPeerId);
                    break;
                case 'new_leader':
                    handleNewLeader(data, fromPeerId);
                    break;
                case 'start_private_chat':
                    handleStartPrivateChat(data, fromPeerId);
                    break;
                case 'private_chat_request':
                    handlePrivateChatRequest(data, fromPeerId);
                    break;
                case 'private_chat_response':
                    handlePrivateChatResponse(data, fromPeerId);
                    break;
            }
        }
        
        function handleUserRegistration(data, fromPeerId) {
            // ÙÙ‚Ø· Ø±Ù‡Ø¨Ø± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø±Ø§ Ø«Ø¨Øª Ú©Ù†Ø¯
            if (!amILeader) return;
            
            const userInfo = {
                peerId: data.peerId,
                visibleName: data.visibleName,
                hiddenName: data.hiddenName,
                isLeader: false,
                isOnline: true,
                lastSeen: Date.now(),
                isMe: false
            };
            
            users.set(data.peerId, userInfo);
            
            // Ø§Ø±Ø³Ø§Ù„ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
            const conn = connections.get(fromPeerId);
            if (conn && conn.open) {
                conn.send({
                    type: 'user_list',
                    users: Array.from(users.values()).filter(u => u.isOnline),
                    timestamp: Date.now()
                });
            }
            
            // Ø§Ø¹Ù„Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù‡Ù…Ù‡
            broadcastToAll({
                type: 'user_joined',
                user: userInfo,
                timestamp: Date.now()
            }, [fromPeerId]);
            
            showNotification(`Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯: ${data.visibleName}`, 'success');
            updateUsersList();
        }
        
        function handlePublicMessage(data, fromPeerId) {
            // Ø§Ú¯Ø± Ø±Ù‡Ø¨Ø± Ù‡Ø³ØªÛŒÙ…ØŒ Ù¾ÛŒØ§Ù… Ø±Ø§ Ø¨Ù‡ Ù‡Ù…Ù‡ Ø¨ÙØ±Ø³Øª
            if (amILeader && data.chatType === 'public') {
                broadcastToAll({
                    type: 'public_message',
                    ...data,
                    fromPeerId: fromPeerId
                }, [fromPeerId]);
            }
            
            // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…
            if (currentChatType === 'public') {
                displayMessage(data, false);
            }
        }
        
        function handlePrivateMessage(data, fromPeerId) {
            // Ù¾ÛŒØ§Ù… Ø®ØµÙˆØµÛŒ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ù…Ø´Ø®Øµ Ø´Ø¯Ù‡ Ø§Ø³Øª
            if (data.toPeerId === myPeerId) {
                // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú†Øª Ø®ØµÙˆØµÛŒ
                savePrivateMessage(data, fromPeerId);
                
                // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø§Ú¯Ø± Ø¯Ø± Ù‡Ù…Ø§Ù† Ú†Øª Ø®ØµÙˆØµÛŒ Ù‡Ø³ØªÛŒÙ…
                if (currentChatType === 'private' && currentPrivateChat === fromPeerId) {
                    displayMessage(data, false, true);
                } else {
                    // Ø§Ø¹Ù„Ø§Ù† Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯
                    showNotification(`Ù¾ÛŒØ§Ù… Ø®ØµÙˆØµÛŒ Ø§Ø² ${data.senderName}`, 'info');
                    
                    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ú†Øªâ€ŒÙ‡Ø§ÛŒ Ø®ØµÙˆØµÛŒ
                    updatePrivateChatsList();
                }
            }
        }
        
        function handleUserList(data, fromPeerId) {
            // Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø² Ø±Ù‡Ø¨Ø±
            data.users.forEach(user => {
                if (user.peerId !== myPeerId) {
                    users.set(user.peerId, user);
                }
            });
            
            updateUsersList();
        }
        
        function handleHeartbeat(data, fromPeerId) {
            const user = users.get(fromPeerId);
            if (user) {
                user.lastSeen = Date.now();
                user.isOnline = true;
            }
            
            // Ù¾Ø§Ø³Ø® Ø¨Ù‡ heartbeat
            const conn = connections.get(fromPeerId);
            if (conn && conn.open) {
                conn.send({
                    type: 'heartbeat_response',
                    timestamp: Date.now()
                });
            }
        }
        
        function handleNewLeader(data, fromPeerId) {
            // Ø±Ù‡Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ù…Ø¹Ø±ÙÛŒ Ø´Ø¯Ù‡
            currentLeaderId = data.leaderId;
            amILeader = false;
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ù‡Ø¨Ø± Ø¯Ø± localStorage
            localStorage.setItem('global_leader', JSON.stringify({
                peerId: data.leaderId,
                visibleName: data.leaderName,
                timestamp: Date.now()
            }));
            
            // Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø±Ù‡Ø¨Ø± Ø¬Ø¯ÛŒØ¯
            if (currentLeaderId !== myPeerId && !connections.has(currentLeaderId)) {
                connectToLeader();
            }
            
            showNotification(`Ø±Ù‡Ø¨Ø± Ø¬Ø¯ÛŒØ¯: ${data.leaderName}`, 'info');
            updateUI();
        }
        
        function handleStartPrivateChat(data, fromPeerId) {
            // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ø±ÙˆØ¹ Ú†Øª Ø®ØµÙˆØµÛŒ
            const confirmStart = confirm(`Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ú†Øª Ø®ØµÙˆØµÛŒ Ø¨Ø§ ${data.senderName} Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯ØŸ`);
            
            if (confirmStart) {
                // Ø§ÛŒØ¬Ø§Ø¯ Ú†Øª Ø®ØµÙˆØµÛŒ
                createPrivateChat(data.senderId, data.senderName);
                
                // Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª
                const conn = connections.get(fromPeerId);
                if (conn && conn.open) {
                    conn.send({
                        type: 'private_chat_response',
                        accepted: true,
                        toPeerId: data.senderId,
                        myPeerId: myPeerId,
                        myName: myVisibleName,
                        timestamp: Date.now()
                    });
                }
            }
        }
        
        function handlePrivateChatRequest(data, fromPeerId) {
            // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª Ø®ØµÙˆØµÛŒ
            if (!privateChats.has(fromPeerId)) {
                privateChats.set(fromPeerId, {
                    peerId: fromPeerId,
                    visibleName: data.senderName,
                    messages: [],
                    unread: 1,
                    lastActivity: Date.now()
                });
                
                showNotification(`Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª Ø®ØµÙˆØµÛŒ Ø§Ø² ${data.senderName}`, 'info');
                updatePrivateChatsList();
            }
        }
        
        function handlePrivateChatResponse(data, fromPeerId) {
            if (data.accepted) {
                // Ú†Øª Ø®ØµÙˆØµÛŒ Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯
                createPrivateChat(data.toPeerId, data.myName);
                
                showNotification(`Ú†Øª Ø®ØµÙˆØµÛŒ Ø¨Ø§ ${data.myName} Ø´Ø±ÙˆØ¹ Ø´Ø¯`, 'success');
            }
        }
        
        // ==================== Ú†Øª Ø®ØµÙˆØµÛŒ ====================
        function startPrivateChatWith(userPeerId, userName) {
            // Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª Ø®ØµÙˆØµÛŒ
            const conn = connections.get(userPeerId);
            if (conn && conn.open) {
                conn.send({
                    type: 'private_chat_request',
                    senderId: myPeerId,
                    senderName: myVisibleName,
                    timestamp: Date.now()
                });
                
                showNotification(`Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª Ø®ØµÙˆØµÛŒ Ø¨Ù‡ ${userName} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯`, 'info');
            } else {
                showNotification('Ø§ØªØµØ§Ù„ Ø¨Ø§ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†ÛŒØ³Øª', 'error');
            }
        }
        
        function createPrivateChat(peerId, userName) {
            if (!privateChats.has(peerId)) {
                privateChats.set(peerId, {
                    peerId: peerId,
                    visibleName: userName,
                    messages: [],
                    unread: 0,
                    lastActivity: Date.now()
                });
                
                // Ø³ÙˆØ¦ÛŒÚ† Ø¨Ù‡ Ú†Øª Ø®ØµÙˆØµÛŒ
                switchToPrivateChat(peerId);
                
                updatePrivateChatsList();
            }
        }
        
        function switchToPrivateChat(peerId) {
            currentChatType = 'private';
            currentPrivateChat = peerId;
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI
            document.querySelectorAll('.chat-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.chat-type-btn:nth-child(2)').classList.add('active');
            
            document.getElementById('publicUsersSection').style.display = 'none';
            document.getElementById('privateUsersSection').style.display = 'block';
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡Ø¯Ø± Ú†Øª
            const chat = privateChats.get(peerId);
            if (chat) {
                document.getElementById('chatTitle').textContent = `ğŸ”’ Ú†Øª Ø®ØµÙˆØµÛŒ Ø¨Ø§ ${chat.visibleName}`;
                document.getElementById('chatInfo').textContent = 'Ø§ÛŒÙ† Ù…Ú©Ø§Ù„Ù…Ù‡ Ø®ØµÙˆØµÛŒ Ùˆ Ø§Ù…Ù† Ø§Ø³Øª';
                
                // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ú†Øª
                displayPrivateChatMessages(peerId);
            }
            
            // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù†Ø®ÙˆØ§Ù†Ø¯Ù‡
            if (chat) {
                chat.unread = 0;
                updatePrivateChatsList();
            }
        }
        
        function displayPrivateChatMessages(peerId) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            
            const chat = privateChats.get(peerId);
            if (!chat || chat.messages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-lock"></i>
                        <p>Ø´Ø±ÙˆØ¹ Ú†Øª Ø®ØµÙˆØµÛŒ Ø¨Ø§ ${chat?.visibleName || 'Ú©Ø§Ø±Ø¨Ø±'}</p>
                        <p style="font-size: 12px; margin-top: 10px;">Ù‡Ù…Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù‡ Ùˆ Ø®ØµÙˆØµÛŒ Ù‡Ø³ØªÙ†Ø¯</p>
                    </div>
                `;
                return;
            }
            
            chat.messages.forEach(message => {
                const isOutgoing = message.senderId === myPeerId;
                displayMessage(message, isOutgoing, true);
            });
            
            // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ†
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }
        
        function savePrivateMessage(data, fromPeerId) {
            if (!privateChats.has(fromPeerId)) {
                createPrivateChat(fromPeerId, data.senderName);
            }
            
            const chat = privateChats.get(fromPeerId);
            chat.messages.push({
                ...data,
                timestamp: data.timestamp || Date.now()
            });
            chat.lastActivity = Date.now();
            
            // Ø§Ú¯Ø± Ø¯Ø± Ø§ÛŒÙ† Ú†Øª Ù†ÛŒØ³ØªÛŒÙ…ØŒ ØªØ¹Ø¯Ø§Ø¯ Ù†Ø®ÙˆØ§Ù†Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø§ÙØ²Ø§ÛŒØ´ Ø¨Ø¯Ù‡
            if (currentChatType !== 'private' || currentPrivateChat !== fromPeerId) {
                chat.unread = (chat.unread || 0) + 1;
            }
        }
        
        // ==================== Ù…Ø¯ÛŒØ±ÛŒØª Ø´Ø¨Ú©Ù‡ ====================
        function broadcastToAll(data, excludePeers = []) {
            connections.forEach((conn, peerId) => {
                if (conn.open && !excludePeers.includes(peerId)) {
                    try {
                        conn.send(data);
                    } catch (error) {
                        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡:', peerId, error);
                    }
                }
            });
        }
        
        function startHeartbeatSystem() {
            // Ø§Ø±Ø³Ø§Ù„ heartbeat Ù…Ù†Ø¸Ù…
            heartbeatInterval = setInterval(() => {
                if (amILeader) {
                    // Ø±Ù‡Ø¨Ø± heartbeat Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
                    broadcastToAll({
                        type: 'heartbeat',
                        leaderId: myPeerId,
                        timestamp: Date.now()
                    });
                }
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢ÙÙ„Ø§ÛŒÙ†
                checkOfflineUsers();
            }, 15000); // Ù‡Ø± 15 Ø«Ø§Ù†ÛŒÙ‡
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø³Ù„Ø§Ù…Øª Ø±Ù‡Ø¨Ø± (Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ø¶Ø§)
            if (!amILeader) {
                leaderCheckInterval = setInterval(() => {
                    checkLeaderHealth();
                }, 20000); // Ù‡Ø± 20 Ø«Ø§Ù†ÛŒÙ‡
            }
        }
        
        function checkOfflineUsers() {
            const now = Date.now();
            users.forEach((user, peerId) => {
                if (peerId !== myPeerId && now - user.lastSeen > 45000) { // 45 Ø«Ø§Ù†ÛŒÙ‡
                    user.isOnline = false;
                    
                    // Ø§Ú¯Ø± Ø±Ù‡Ø¨Ø± Ø¢ÙÙ„Ø§ÛŒÙ† Ø´Ø¯ Ùˆ Ù…Ø§ Ø±Ù‡Ø¨Ø± Ù†ÛŒØ³ØªÛŒÙ…
                    if (user.isLeader && !amILeader && peerId === currentLeaderId) {
                        // Ø¨Ø¹Ø¯ Ø§Ø² 2 Ø¨Ø§Ø± Ú†Ú©ØŒ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø±Ù‡Ø¨Ø± Ø´Ùˆ
                        if (user.offlineChecks) {
                            user.offlineChecks++;
                            if (user.offlineChecks >= 2) {
                                handleLeaderDisconnected();
                            }
                        } else {
                            user.offlineChecks = 1;
                        }
                    }
                }
            });
            
            updateUsersList();
        }
        
        function checkLeaderHealth() {
            if (!amILeader && currentLeaderId) {
                const leaderConn = connections.get(currentLeaderId);
                if (!leaderConn || !leaderConn.open) {
                    // Ø±Ù‡Ø¨Ø± Ø¢ÙÙ„Ø§ÛŒÙ† Ø§Ø³Øª
                    const leaderUser = users.get(currentLeaderId);
                    if (leaderUser) {
                        leaderUser.isOnline = false;
                        handleLeaderDisconnected();
                    }
                }
            }
        }
        
        function startLeaderDiscovery() {
            // Ø±Ù‡Ø¨Ø± Ø¨Ù‡ ØµÙˆØ±Øª Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ù…Ø¹Ø±ÙÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
            setInterval(() => {
                broadcastToAll({
                    type: 'heartbeat',
                    leaderId: myPeerId,
                    leaderName: myVisibleName,
                    timestamp: Date.now()
                });
            }, 30000); // Ù‡Ø± 30 Ø«Ø§Ù†ÛŒÙ‡
        }
        
        // ==================== UI Functions ====================
        function updateUI() {
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØªØµØ§Ù„
            document.getElementById('connectionStatus').textContent = 
                amILeader ? 'ğŸ‘‘ Ø±Ù‡Ø¨Ø± Ø´Ø¨Ú©Ù‡' : 'ğŸ‘¤ Ø¹Ø¶Ùˆ Ø´Ø¨Ú©Ù‡';
            
            document.getElementById('leaderText').textContent = 
                amILeader ? 'Ø´Ù…Ø§ Ø±Ù‡Ø¨Ø± Ù‡Ø³ØªÛŒØ¯' : `Ø±Ù‡Ø¨Ø±: ${users.get(currentLeaderId)?.visibleName || '...'}`;
            
            const onlineCount = Array.from(users.values()).filter(u => u.isOnline).length;
            document.getElementById('onlineCount').textContent = onlineCount;
            document.getElementById('userCount').textContent = onlineCount;
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
            updateUsersList();
            updatePrivateChatsList();
        }
        
        function updateUsersList() {
            const container = document.getElementById('publicUsersList');
            container.innerHTML = '';
            
            let hasUsers = false;
            
            users.forEach((user, peerId) => {
                if (peerId !== myPeerId && user.isOnline) {
                    hasUsers = true;
                    
                    const userEl = document.createElement('div');
                    userEl.className = `user-item ${user.isLeader ? 'active' : ''}`;
                    userEl.onclick = () => {
                        if (!user.isLeader && currentChatType === 'public') {
                            const confirmStart = confirm(`Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ú†Øª Ø®ØµÙˆØµÛŒ Ø¨Ø§ ${user.visibleName} Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯ØŸ`);
                            if (confirmStart) {
                                startPrivateChatWith(peerId, user.visibleName);
                            }
                        }
                    };
                    
                    userEl.innerHTML = `
                        <div class="user-avatar" style="background: ${user.isLeader ? 'linear-gradient(135deg, #f59e0b, #f97316)' : 'linear-gradient(135deg, #3b82f6, #8b5cf6)'}">
                            ${user.visibleName.charAt(0)}
                        </div>
                        <div class="user-info">
                            <div class="user-name">
                                ${user.visibleName}
                                ${user.isLeader ? '<span class="badge leader">Ø±Ù‡Ø¨Ø±</span>' : ''}
                                <span class="badge online">Ø¢Ù†Ù„Ø§ÛŒÙ†</span>
                            </div>
                            <div class="user-status-text">${user.hiddenName}</div>
                        </div>
                    `;
                    
                    container.appendChild(userEl);
                }
            });
            
            if (!hasUsers) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 20px 0;">
                        <i class="fas fa-user-plus"></i>
                        <p>Ú©Ø§Ø±Ø¨Ø± Ø¢Ù†Ù„Ø§ÛŒÙ† Ø¯ÛŒÚ¯Ø±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</p>
                        <p style="font-size: 12px; margin-top: 10px;">Ø¨Ù‡ Ø¯ÙˆØ³ØªØ§Ù† Ø®ÙˆØ¯ Ø¨Ú¯ÙˆÛŒÛŒØ¯ Ø¨Ù‡ Ú†Øª Ø¨Ù¾ÛŒÙˆÙ†Ø¯Ù†Ø¯</p>
                    </div>
                `;
            }
        }
        
        function updatePrivateChatsList() {
            const container = document.getElementById('privateUsersList');
            container.innerHTML = '';
            
            if (privateChats.size === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 20px 0;">
                        <i class="fas fa-lock"></i>
                        <p>Ú†Øª Ø®ØµÙˆØµÛŒ ÙØ¹Ø§Ù„ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯</p>
                        <p style="font-size: 12px; margin-top: 10px;">Ø±ÙˆÛŒ ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ú†Øª Ø®ØµÙˆØµÛŒ Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯</p>
                    </div>
                `;
                return;
            }
            
            privateChats.forEach((chat, peerId) => {
                const user = users.get(peerId);
                if (!user) return;
                
                const chatEl = document.createElement('div');
                chatEl.className = `user-item private ${currentPrivateChat === peerId ? 'active' : ''}`;
                chatEl.onclick = () => switchToPrivateChat(peerId);
                
                const unreadBadge = chat.unread > 0 ? 
                    `<span class="private-indicator">${chat.unread}</span>` : '';
                
                chatEl.innerHTML = `
                    <div class="user-avatar" style="background: linear-gradient(135deg, #8b5cf6, #a78bfa)">
                        ${user.visibleName.charAt(0)}
                    </div>
                    <div class="user-info">
                        <div class="user-name">
                            ${user.visibleName}
                            <span class="badge private">Ø®ØµÙˆØµÛŒ</span>
                        </div>
                        <div class="user-status-text">
                            ${chat.messages.length} Ù¾ÛŒØ§Ù…
                        </div>
                    </div>
                    ${unreadBadge}
                `;
                
                container.appendChild(chatEl);
            });
        }
        
        function switchChatType(type) {
            currentChatType = type;
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
            document.querySelectorAll('.chat-type-btn').forEach((btn, index) => {
                btn.classList.toggle('active', index === (type === 'public' ? 0 : 1));
            });
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨Ø®Ø´â€ŒÙ‡Ø§
            document.getElementById('publicUsersSection').style.display = 
                type === 'public' ? 'block' : 'none';
            document.getElementById('privateUsersSection').style.display = 
                type === 'private' ? 'block' : 'none';
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡Ø¯Ø± Ú†Øª
            if (type === 'public') {
                document.getElementById('chatTitle').textContent = 'ğŸ’¬ Ú†Øª Ø¹Ù…ÙˆÙ…ÛŒ Ø¬Ù‡Ø§Ù†ÛŒ';
                document.getElementById('chatInfo').textContent = 'Ù‡Ù…Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯';
                
                // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ
                displayPublicMessages();
            } else if (type === 'private' && currentPrivateChat) {
                const chat = privateChats.get(currentPrivateChat);
                if (chat) {
                    document.getElementById('chatTitle').textContent = `ğŸ”’ Ú†Øª Ø®ØµÙˆØµÛŒ Ø¨Ø§ ${chat.visibleName}`;
                    document.getElementById('chatInfo').textContent = 'Ø§ÛŒÙ† Ù…Ú©Ø§Ù„Ù…Ù‡ Ø®ØµÙˆØµÛŒ Ùˆ Ø§Ù…Ù† Ø§Ø³Øª';
                    
                    displayPrivateChatMessages(currentPrivateChat);
                }
            } else {
                document.getElementById('chatTitle').textContent = 'ğŸ”’ Ú†Øª Ø®ØµÙˆØµÛŒ';
                document.getElementById('chatInfo').textContent = 'ÛŒÚ© Ú†Øª Ø®ØµÙˆØµÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯';
                document.getElementById('messagesContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-lock"></i>
                        <p>ÛŒÚ© Ú†Øª Ø®ØµÙˆØµÛŒ Ø±Ø§ Ø§Ø² Ù„ÛŒØ³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</p>
                    </div>
                `;
            }
        }
        
        function displayPublicMessages() {
            // Ø¯Ø± ÛŒÚ© Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ØŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
            const container = document.getElementById('messagesContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (emptyState) {
                emptyState.style.display = 'block';
            }
        }
        
        function displayMessage(data, isOutgoing, isPrivate = false) {
            const container = document.getElementById('messagesContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            const messageEl = document.createElement('div');
            messageEl.className = `message ${isOutgoing ? 'outgoing' : 'incoming'} ${isPrivate ? 'private' : ''}`;
            
            messageEl.innerHTML = `
                <div class="message-header">
                    <div class="message-sender">${data.senderName || (isOutgoing ? myVisibleName : 'Ú©Ø§Ø±Ø¨Ø±')}</div>
                    <div class="message-time">${formatTime(data.timestamp)}</div>
                </div>
                <div class="message-content">${escapeHtml(data.content)}</div>
                ${isOutgoing ? `
                    <div class="message-footer">
                        <div class="message-status">${isPrivate ? 'ğŸ”’ Ø®ØµÙˆØµÛŒ' : 'Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯'}</div>
                    </div>
                ` : ''}
            `;
            
            container.appendChild(messageEl);
            
            // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ†
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content) return;
            
            const messageData = {
                type: currentChatType === 'public' ? 'public_message' : 'private_message',
                content: content,
                senderId: myPeerId,
                senderName: myVisibleName,
                timestamp: Date.now(),
                chatType: currentChatType
            };
            
            // Ø§Ú¯Ø± Ú†Øª Ø®ØµÙˆØµÛŒ Ø§Ø³ØªØŒ Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†
            if (currentChatType === 'private' && currentPrivateChat) {
                messageData.toPeerId = currentPrivateChat;
                
                // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø­Ù„ÛŒ
                savePrivateMessage({
                    ...messageData,
                    senderId: myPeerId
                }, currentPrivateChat);
            }
            
            // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯Ù…Ø§Ù†
            displayMessage(messageData, true, currentChatType === 'private');
            
            // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
            if (currentChatType === 'public') {
                // Ø§Ú¯Ø± Ø±Ù‡Ø¨Ø± Ù‡Ø³ØªÛŒÙ…ØŒ Ø¨Ù‡ Ù‡Ù…Ù‡ Ø¨ÙØ±Ø³Øª
                if (amILeader) {
                    broadcastToAll(messageData);
                } else {
                    // Ø§Ú¯Ø± Ø¹Ø¶Ùˆ Ù‡Ø³ØªÛŒÙ…ØŒ Ø¨Ù‡ Ø±Ù‡Ø¨Ø± Ø¨ÙØ±Ø³Øª
                    const leaderConn = connections.get(currentLeaderId);
                    if (leaderConn && leaderConn.open) {
                        leaderConn.send(messageData);
                    }
                }
            } else {
                // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø®ØµÙˆØµÛŒ
                const targetConn = connections.get(currentPrivateChat);
                if (targetConn && targetConn.open) {
                    targetConn.send(messageData);
                }
            }
            
            input.value = '';
            autoResize(input);
        }
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        function refreshNetwork() {
            showNotification('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¨Ú©Ù‡...', 'info');
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¬Ø¯Ø¯ ÙˆØ¶Ø¹ÛŒØª Ø±Ù‡Ø¨Ø±
            if (!amILeader && currentLeaderId) {
                const leaderConn = connections.get(currentLeaderId);
                if (!leaderConn || !leaderConn.open) {
                    showNotification('Ø±Ù‡Ø¨Ø± Ø¢ÙÙ„Ø§ÛŒÙ† Ø§Ø³Øª. ØªØ¨Ø¯ÛŒÙ„ Ø´Ø¯Ù† Ø¨Ù‡ Ø±Ù‡Ø¨Ø± Ø¬Ø¯ÛŒØ¯...', 'warning');
                    amILeader = true;
                    currentLeaderId = myPeerId;
                    setupAsLeader();
                }
            }
            
            // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
            updateUsersList();
            
            setTimeout(() => {
                showNotification('âœ… Ø´Ø¨Ú©Ù‡ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯', 'success');
            }, 1000);
        }
        
        function leaveChat() {
            if (confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø² Ú†Øª Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ØŸ')) {
                // Ø¨Ø³ØªÙ† Ù‡Ù…Ù‡ Ø§ØªØµØ§Ù„Ø§Øª
                connections.forEach(conn => conn.close());
                connections.clear();
                
                // ØªÙˆÙ‚Ù intervalÙ‡Ø§
                if (heartbeatInterval) clearInterval(heartbeatInterval);
                if (leaderCheckInterval) clearInterval(leaderCheckInterval);
                
                // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('chatContainer').style.display = 'none';
                
                showNotification('Ø§Ø² Ú†Øª Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯', 'info');
            }
        }
    </script>
</body>
</html>
