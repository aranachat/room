<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8" />
<title>P2P Chat with Admin & Private E2EE</title>

<!-- PeerJS -->
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<!-- CryptoJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

<style>
body {
    font-family: sans-serif;
    margin: 0;
    background: #f4f4f4;
}

#topBar {
    background: #222;
    color: #fff;
    padding: 10px;
}

#container {
    display: flex;
    height: calc(100vh - 50px);
}

#users {
    width: 200px;
    background: #fff;
    border-right: 1px solid #ccc;
    overflow-y: auto;
}

#users div {
    padding: 8px;
    cursor: pointer;
}

#users div:hover {
    background: #eee;
}

#chat {
    flex: 1;
    display: flex;
    flex-direction: column;
}

#messages {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
}

.message {
    margin-bottom: 8px;
}

.message img {
    max-width: 250px;
    border-radius: 8px;
}

#inputBar {
    display: flex;
    padding: 10px;
    background: #ddd;
}

#inputBar input {
    flex: 1;
    padding: 6px;
}

#floatingPrivateChat {
    position: fixed;
    bottom: 90px;
    left: 20px;
    width: 320px;
    height: 420px;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0,0,0,.3);
    display: none;
    flex-direction: column;
    z-index: 9999;
}

#floatingPrivateChat header {
    padding: 10px;
    background: #222;
    color: #fff;
    border-radius: 16px 16px 0 0;
}

#floatingMessages {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
}

#floatingInput {
    border: none;
    border-top: 1px solid #ccc;
    padding: 8px;
    resize: none;
}
</style>
</head>

<body>

<div id="topBar">
    <span id="adminText"></span>
</div>

<div id="container">
    <div id="users"></div>

    <div id="chat">
        <div id="messages"></div>
        <div id="inputBar">
            <input id="messageInput" placeholder="پیام عمومی..." />
            <input type="file" id="imageInput" />
        </div>
    </div>
</div>

<div id="floatingPrivateChat">
    <header id="floatingHeader"></header>
    <div id="floatingMessages"></div>
    <textarea id="floatingInput" placeholder="پیام خصوصی..."></textarea>
</div>

<script>
/* ===================== CONFIG ===================== */
const GLOBAL_ROOM = "global_room";
const ADMIN_NAME = "admin";
const ADMIN_PEER_ID = GLOBAL_ROOM + "_" + ADMIN_NAME;

/* ===================== STATE ===================== */
let peer;
let myPeerId;
let myVisibleName = prompt("نام شما؟") || "کاربر";
let isAdmin = false;

let connections = new Map();
let privateChats = new Map();
let incomingImages = new Map();

let currentPrivateChatWith = null;

/* ===================== INIT ===================== */
peer = new Peer();

peer.on("open", id => {
    myPeerId = id;
    isAdmin = myVisibleName === ADMIN_NAME;

    document.getElementById("adminText").textContent =
        isAdmin ? "شما مدیریت هستید" : "مدیریت: " + ADMIN_NAME;

    if (!isAdmin) connectToAdmin();
});

peer.on("connection", conn => {
    if (conn.metadata?.type === "private_p2p") {
        setupPrivateConnection(conn);
    } else {
        setupPublicConnection(conn);
    }
});

/* ===================== PUBLIC CHAT ===================== */
function connectToAdmin() {
    const conn = peer.connect(ADMIN_PEER_ID, {
        metadata: { name: myVisibleName }
    });
    setupPublicConnection(conn);
}

function setupPublicConnection(conn) {
    conn.on("open", () => {
        connections.set(conn.peer, conn);
        updateUsers();
    });

    conn.on("data", data => handlePublicData(data));

    conn.on("close", () => {
        connections.delete(conn.peer);
        updateUsers();
    });
}

function handlePublicData(data) {
    if (data.type === "message") {
        displayMessage(data);
    }
    if (data.type === "image_chunk") {
        handleImageChunk(data);
    }
}

function sendPublicMessage(text) {
    const msg = {
        type: "message",
        senderName: myVisibleName,
        content: text,
        timestamp: Date.now()
    };

    displayMessage(msg);

    connections.forEach(c => c.send(msg));
}

/* ===================== IMAGE TRANSFER ===================== */
function sendImage(file, sendFn) {
    const reader = new FileReader();
    reader.onload = () => {
        const base64 = reader.result.split(",")[1];
        const chunkSize = 16000;
        const total = Math.ceil(base64.length / chunkSize);
        const messageId = crypto.randomUUID();

        for (let i = 0; i < total; i++) {
            sendFn({
                type: "image_chunk",
                messageId,
                chunkIndex: i,
                totalChunks: total,
                data: base64.slice(i * chunkSize, (i + 1) * chunkSize),
                senderName: myVisibleName
            });
        }
    };
    reader.readAsDataURL(file);
}

function handleImageChunk(data) {
    if (!incomingImages.has(data.messageId)) {
        incomingImages.set(data.messageId, {
            chunks: [],
            total: data.totalChunks,
            senderName: data.senderName
        });
    }

    const img = incomingImages.get(data.messageId);
    img.chunks[data.chunkIndex] = data.data;

    if (img.chunks.filter(Boolean).length === img.total) {
        displayMessage({
            type: "image",
            senderName: img.senderName,
            content: img.chunks.join("")
        });
        incomingImages.delete(data.messageId);
    }
}

/* ===================== PRIVATE CHAT (E2EE) ===================== */
function getSharedSecret(peerId) {
    return CryptoJS.SHA256([myPeerId, peerId].sort().join("|")).toString();
}

function openPrivate(peerId, name) {
    currentPrivateChatWith = peerId;

    document.getElementById("floatingPrivateChat").style.display = "flex";
    document.getElementById("floatingHeader").textContent =
        "چت خصوصی با " + name;

    if (!privateChats.has(peerId)) {
        const conn = peer.connect(peerId, {
            metadata: { type: "private_p2p" }
        });
        setupPrivateConnection(conn);
    }
}

function setupPrivateConnection(conn) {
    const peerId = conn.peer;

    if (!privateChats.has(peerId)) {
        privateChats.set(peerId, { conn, messages: [] });
    }

    conn.on("data", data => {
        if (data.type === "private_message") {
            const secret = getSharedSecret(peerId);
            const text = CryptoJS.AES.decrypt(
                data.payload, secret
            ).toString(CryptoJS.enc.Utf8);

            addPrivateMessage(peerId, data.senderName, text);
        }
    });
}

function sendPrivateMessage(text) {
    const chat = privateChats.get(currentPrivateChatWith);
    if (!chat) return;

    const secret = getSharedSecret(currentPrivateChatWith);
    const encrypted = CryptoJS.AES.encrypt(text, secret).toString();

    chat.conn.send({
        type: "private_message",
        payload: encrypted,
        senderName: myVisibleName
    });

    addPrivateMessage(currentPrivateChatWith, myVisibleName, text);
}

function addPrivateMessage(peerId, sender, text) {
    const box = document.getElementById("floatingMessages");
    const div = document.createElement("div");
    div.textContent = sender + ": " + text;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

/* ===================== UI ===================== */
function displayMessage(msg) {
    const box = document.getElementById("messages");
    const div = document.createElement("div");
    div.className = "message";

    if (msg.type === "image") {
        const img = document.createElement("img");
        img.src = "data:image/*;base64," + msg.content;
        div.appendChild(img);
    } else {
        div.textContent = msg.senderName + ": " + msg.content;
    }

    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

function updateUsers() {
    const box = document.getElementById("users");
    box.innerHTML = "";

    connections.forEach((conn, id) => {
        const div = document.createElement("div");
        div.textContent = id;
        div.onclick = () => openPrivate(id, id);
        box.appendChild(div);
    });
}

/* ===================== EVENTS ===================== */
document.getElementById("messageInput").addEventListener("keydown", e => {
    if (e.key === "Enter") {
        sendPublicMessage(e.target.value);
        e.target.value = "";
    }
});

document.getElementById("floatingInput").addEventListener("keydown", e => {
    if (e.key === "Enter") {
        sendPrivateMessage(e.target.value);
        e.target.value = "";
    }
});

document.getElementById("imageInput").addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;

    sendImage(file, data => {
        connections.forEach(c => c.send(data));
    });
});
</script>

</body>
</html>
