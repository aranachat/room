<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú†Øª Ø¢Ø±Ø§Ù†Ø§ - Ù†Ø³Ø®Ù‡ Ø§Ù…Ù† P2P</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Vazir', sans-serif; }
        body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); min-height: 100vh; overflow: hidden; }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø§ØµÙ„ÛŒ */
        .main-container { display: flex; height: 100vh; padding: 20px; gap: 20px; }
        .sidebar { width: 300px; background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); color: white; display: flex; flex-direction: column; }
        .chat-main { flex: 1; background: white; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† */
        .user-item { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .user-item:hover { background: rgba(255,255,255,0.1); }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #10b981; }

        /* Ù¾Ù†Ø¬Ø±Ù‡ Ø´Ù†Ø§ÙˆØ± Ú†Øª Ø®ØµÙˆØµÛŒ */
        .private-window {
            position: fixed; bottom: 20px; left: 20px; width: 350px; height: 450px;
            background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; z-index: 2000; overflow: hidden;
            border: 2px solid #3b82f6; animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .priv-header { background: #3b82f6; color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; cursor: move; }
        .priv-messages { flex: 1; padding: 10px; overflow-y: auto; background: #f8fafc; display: flex; flex-direction: column; gap: 8px; }
        .priv-input { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 5px; }
        
        /* Ø­Ø¨Ø§Ø¨ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ */
        .msg { padding: 8px 12px; border-radius: 12px; max-width: 80%; font-size: 14px; margin: 2px 0; position: relative; word-wrap: break-word; }
        .msg.sent { background: #3b82f6; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg.received { background: #e2e8f0; color: #1e293b; align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg img { max-width: 100%; border-radius: 8px; margin-top: 5px; display: block; }

        .login-overlay { position: fixed; inset: 0; background: #0f172a; z-index: 3000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 30px; border-radius: 20px; width: 350px; text-align: center; }
        input, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #ddd; outline: none; }
        button { background: #3b82f6; color: white; border: none; cursor: pointer; font-weight: bold; }
    </style>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet">
</head>
<body>

    <div id="loginPage" class="login-overlay">
        <div class="login-box">
            <h2>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¢Ø±Ø§Ù†Ø§</h2>
            <input type="text" id="usernameInput" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ...">
            <button onclick="login()">ÙˆØ±ÙˆØ¯ Ø§Ù…Ù†</button>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <h3 id="managementText">Ù…Ø¯ÛŒØ±ÛŒØª: Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...</h3>
                <small id="myIdDisplay"></small>
            </div>
            <div id="userList" style="flex: 1; overflow-y: auto;">
                </div>
        </div>

        <div class="chat-main">
            <div style="padding: 15px; background: #1e293b; color: white;">Ú†Øª Ø¹Ù…ÙˆÙ…ÛŒ (Ù†Ù…Ø§ÛŒ Ú©Ù„ÛŒ)</div>
            <div id="publicMessages" style="flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column;"></div>
            <div class="priv-input">
                <input type="text" id="publicInput" placeholder="Ù¾ÛŒØ§Ù… Ø¹Ù…ÙˆÙ…ÛŒ...">
                <button onclick="sendPublicMessage()" style="width: 80px;">Ø§Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <div id="privateChatContainer"></div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        let peer, myId, myName;
        let activePrivates = {}; // Ø°Ø®ÛŒØ±Ù‡ Ø§ØªØµØ§Ù„Ø§Øª Ù…Ø³ØªÙ‚ÛŒÙ… P2P
        const GLOBAL_ROOM = "ARANA_SECURE_P2P_V4";

        async function login() {
            myName = document.getElementById('usernameInput').value;
            if(!myName) return alert("Ù†Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
            
            // ØªÙˆÙ„ÛŒØ¯ ID Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù† Ø¨Ø±Ø§ÛŒ ÛŒÚ©ØªØ§ Ø¨ÙˆØ¯Ù†
            myId = GLOBAL_ROOM + "_" + Math.floor(Math.random() * 10000);
            initPeer();
        }

        function initPeer() {
            peer = new Peer(myId);

            peer.on('open', (id) => {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('myIdDisplay').innerText = "Ø´Ù†Ø§Ø³Ù‡ Ø´Ù…Ø§: " + id;
                checkManagement();
            });

            // Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú†Øª Ù…Ø³ØªÙ‚ÛŒÙ… (P2P ÙˆØ§Ù‚Ø¹ÛŒ)
            peer.on('connection', (conn) => {
                setupP2PConnection(conn);
            });
        }

        // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø´Ø¨Ú©Ù‡
        function checkManagement() {
            const mgmtId = GLOBAL_ROOM + "_ADMIN";
            const testConn = peer.connect(mgmtId);
            
            let timeout = setTimeout(() => {
                // Ø§Ú¯Ø± Ú©Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ù†Ø¨ÙˆØ¯ØŒ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø§Ø¯Ù…ÛŒÙ† (Ù…Ø¯ÛŒØ±ÛŒØª) Ù…ÛŒâ€ŒØ´ÙˆØ¯
                becomeManagement(mgmtId);
            }, 3000);

            testConn.on('open', () => {
                clearTimeout(timeout);
                document.getElementById('managementText').innerText = "Ù…Ø¯ÛŒØ±ÛŒØª: ÙØ¹Ø§Ù„";
                announcePresence(testConn);
            });
        }

        function becomeManagement(id) {
            peer.destroy();
            peer = new Peer(id);
            peer.on('open', () => {
                document.getElementById('managementText').innerText = "Ù…Ø¯ÛŒØ±ÛŒØª: Ø´Ù…Ø§ Ù‡Ø³ØªÛŒØ¯";
                document.getElementById('loginPage').style.display = 'none';
                
                peer.on('connection', (conn) => {
                    if(conn.metadata?.type === 'presence') {
                        updateUserListUI(conn.peer, conn.metadata.name);
                    }
                });
            });
        }

        // Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§ØªØµØ§Ù„ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨ÛŒÙ† Ø¯Ùˆ Ù†ÙØ±
        function openPrivateChat(targetPeerId, targetName) {
            if (activePrivates[targetPeerId]) return;

            const conn = peer.connect(targetPeerId, {
                metadata: { name: myName }
            });

            createPrivateWindow(targetPeerId, targetName, conn);
            setupP2PConnection(conn);
        }

        function setupP2PConnection(conn) {
            conn.on('open', () => {
                if (!activePrivates[conn.peer]) {
                    createPrivateWindow(conn.peer, conn.metadata.name, conn);
                }
                activePrivates[conn.peer].conn = conn;
            });

            conn.on('data', (data) => {
                displayMessage(conn.peer, data, 'received');
            });
        }

        function createPrivateWindow(peerId, name, conn) {
            const win = document.createElement('div');
            win.className = 'private-window';
            win.id = `win_${peerId}`;
            win.innerHTML = `
                <div class="priv-header">
                    <span>Ú†Øª Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø§: ${name}</span>
                    <button onclick="closeWin('${peerId}')" style="width:30px; background:none;">Ã—</button>
                </div>
                <div id="msg_box_${peerId}" class="priv-messages"></div>
                <div class="priv-input">
                    <input type="text" id="input_${peerId}" placeholder="Ù¾ÛŒØ§Ù… Ø®ØµÙˆØµÛŒ...">
                    <label style="cursor:pointer; background:#10b981; padding:5px; border-radius:5px; color:white; font-size:12px;">
                        ğŸ–¼ï¸ <input type="file" style="display:none" onchange="sendImage(this, '${peerId}')">
                    </label>
                    <button onclick="sendPrivateText('${peerId}')" style="width:60px;">Ø§Ø±Ø³Ø§Ù„</button>
                </div>
            `;
            document.getElementById('privateChatContainer').appendChild(win);
            activePrivates[peerId] = { name, conn };
        }

        function sendPrivateText(peerId) {
            const input = document.getElementById(`input_${peerId}`);
            const msg = input.value;
            if(!msg) return;

            activePrivates[peerId].conn.send({ type: 'text', content: msg });
            displayMessage(peerId, { type: 'text', content: msg }, 'sent');
            input.value = '';
        }

        // Ø§Ø±Ø³Ø§Ù„ ØªØµÙˆÛŒØ± Ø¨Ù‡ ØµÙˆØ±Øª Ù…Ø³ØªÙ‚ÛŒÙ… (Base64)
        function sendImage(input, peerId) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const imageData = { type: 'image', content: e.target.result };
                activePrivates[peerId].conn.send(imageData);
                displayMessage(peerId, imageData, 'sent');
            };
            reader.readAsDataURL(file);
        }

        function displayMessage(peerId, data, type) {
            const box = document.getElementById(`msg_box_${peerId}`);
            if(!box) return;

            const div = document.createElement('div');
            div.className = `msg ${type}`;
            
            if (data.type === 'text') {
                div.innerText = data.content;
            } else if (data.type === 'image') {
                const img = document.createElement('img');
                img.src = data.content;
                div.appendChild(img);
            }

            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function updateUserListUI(id, name) {
            if(id === myId) return;
            const list = document.getElementById('userList');
            if(document.getElementById(`user_${id}`)) return;

            const item = document.createElement('div');
            item.className = 'user-item';
            item.id = `user_${id}`;
            item.innerHTML = `<div class="status-dot"></div> ${name}`;
            item.onclick = () => openPrivateChat(id, name);
            list.appendChild(item);
        }

        function closeWin(id) {
            document.getElementById(`win_${id}`).remove();
            delete activePrivates[id];
        }

        function announcePresence(conn) {
            conn.send({ type: 'presence', name: myName });
        }
    </script>
</body>
</html>
