<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú†Øª Ø±ÙˆÙ… Ø¹Ù…ÙˆÙ…ÛŒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazir', sans-serif;
        }
        
        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --secondary: #764ba2;
            --success: #48bb78;
            --danger: #f56565;
            --warning: #ed8936;
            --light: #f7fafc;
            --dark: #2d3748;
            --gray: #a0aec0;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .login-page {
            padding: 40px;
            text-align: center;
        }
        
        .chat-page {
            display: none;
            height: 85vh;
            flex-direction: column;
        }
        
        .header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .room-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .room-code {
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 10px;
            font-family: monospace;
            cursor: pointer;
        }
        
        .users-list {
            padding: 15px;
            background: var(--light);
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 120px;
            overflow-y: auto;
        }
        
        .user-badge {
            background: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .online { background: var(--success); }
        .offline { background: var(--gray); }
        .admin { background: var(--warning); }
        
        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .message {
            max-width: 75%;
            padding: 12px 15px;
            border-radius: 15px;
            position: relative;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .incoming {
            background: white;
            align-self: flex-start;
            border-bottom-right-radius: 5px;
        }
        
        .outgoing {
            background: var(--primary);
            color: white;
            align-self: flex-end;
            border-bottom-left-radius: 5px;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 12px;
            opacity: 0.8;
        }
        
        .message-content {
            line-height: 1.5;
            word-break: break-word;
        }
        
        .message-time {
            font-size: 11px;
            text-align: left;
            margin-top: 5px;
        }
        
        .input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 25px;
            font-size: 14px;
            resize: none;
            outline: none;
            transition: border 0.3s;
        }
        
        .message-input:focus {
            border-color: var(--primary);
        }
        
        .send-btn {
            padding: 12px 25px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .send-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            animation: notificationIn 0.3s ease;
        }
        
        @keyframes notificationIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification.success { border-right: 4px solid var(--success); }
        .notification.error { border-right: 4px solid var(--danger); }
        .notification.info { border-right: 4px solid var(--primary); }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e2e8f0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .login-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            text-align: center;
            outline: none;
            transition: border 0.3s;
        }
        
        .login-input:focus {
            border-color: var(--primary);
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            margin: 20px 0;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .login-btn:hover {
            background: var(--primary-dark);
        }
        
        .connection-stats {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 10px;
        }
        
        .admin-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .admin-btn {
            background: var(--warning);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .discovery-panel {
            background: #edf2f7;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .discovery-panel h4 {
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .user-item:hover {
            background: #e2e8f0;
        }
        
        .connect-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet">
</head>
<body>
    <div class="container" id="loginPage">
        <div class="login-page">
            <h1 style="color: var(--primary); margin-bottom: 10px;">ğŸ§  Ú†Øª Ø±ÙˆÙ… Ù‡ÙˆØ´Ù…Ù†Ø¯</h1>
            <p style="color: var(--dark); margin-bottom: 30px;">Ø³ÛŒØ³ØªÙ… Ú©Ø´Ù Ø®ÙˆØ¯Ú©Ø§Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</p>
            
            <input type="text" 
                   class="login-input" 
                   id="usernameInput" 
                   placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"
                   maxlength="20">
            
            <div class="discovery-panel">
                <h4>ğŸ’¡ Ø±ÙˆØ´ Ú©Ø§Ø±:</h4>
                <p style="font-size: 14px; color: var(--dark); margin-bottom: 10px;">
                    Ø³ÛŒØ³ØªÙ… Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ† Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
                    ÙÙ‚Ø· Ú©Ø§ÙÛŒØ³Øª Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ Ùˆ Ø¯Ú©Ù…Ù‡ ÙˆØ±ÙˆØ¯ Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.
                </p>
                <p style="font-size: 12px; color: var(--gray);">
                    Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¯ÛŒÚ¯Ø±ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ† Ù†Ø¨Ø§Ø´Ø¯ØŒ Ø´Ù…Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø§ÙˆÙ„ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±Ø¯ Ù…ÛŒâ€ŒØ´ÙˆÛŒØ¯
                    Ùˆ Ø¯ÛŒÚ¯Ø±Ø§Ù† Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø´Ù…Ø§ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ø®ÙˆØ§Ù‡Ù†Ø¯ Ú©Ø±Ø¯.
                </p>
            </div>
            
            <button class="login-btn" id="loginBtn" onclick="login()">
                <span id="loginBtnText">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú†Øª Ø±ÙˆÙ…</span>
            </button>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                <button onclick="showRoomCode()" 
                        style="width: 100%; padding: 10px; background: var(--warning); color: white; border: none; border-radius: 10px; cursor: pointer;">
                    Ù†Ù…Ø§ÛŒØ´ Ú©Ø¯ Ø§ØªØ§Ù‚
                </button>
                <button onclick="resetAllData()" 
                        style="width: 100%; padding: 10px; margin-top: 10px; background: var(--danger); color: white; border: none; border-radius: 10px; cursor: pointer;">
                    Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„
                </button>
            </div>
        </div>
    </div>
    
    <div class="container chat-page" id="chatPage">
        <div class="header">
            <div class="room-info">
                <div>
                    <h3>ğŸ’¬ Ú†Øª Ø¹Ù…ÙˆÙ…ÛŒ</h3>
                    <p id="connectionStatus">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...</p>
                </div>
                <div class="room-code" onclick="copyRoomCode()" title="Ú©Ù¾ÛŒ Ú©Ø¯ Ø§ØªØ§Ù‚">
                    <span id="roomCodeDisplay">...</span>
                </div>
            </div>
            
            <div class="admin-controls">
                <div id="adminBadge" style="display: none;">
                    <span class="admin-btn">Ø§Ø¯Ù…ÛŒÙ†</span>
                </div>
                <button class="admin-btn" onclick="refreshNetwork()" title="Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¨Ú©Ù‡">
                    ğŸ”„
                </button>
                <button class="admin-btn" onclick="leaveChat()" title="Ø®Ø±ÙˆØ¬">
                    Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </div>
        
        <div class="users-list" id="usersList">
            <!-- Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† -->
        </div>
        
        <div class="messages-container" id="messagesContainer">
            <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ -->
        </div>
        
        <div class="input-area">
            <textarea id="messageInput" 
                      class="message-input" 
                      placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." 
                      rows="1"
                      onkeydown="handleKeyPress(event)"
                      oninput="autoResize(this)"></textarea>
            <button onclick="sendMessage()" id="sendBtn" class="send-btn">Ø§Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        // ==================== Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ ====================
        let peer = null;
        let myId = null;
        let myUsername = null;
        let roomCode = null;
        
        let connections = new Map(); // Ø§ØªØµØ§Ù„Ø§Øª ÙØ¹Ø§Ù„
        let discoveredPeers = new Set(); // peerÙ‡Ø§ÛŒ Ú©Ø´Ù Ø´Ø¯Ù‡
        let userDirectory = new Map(); // Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
        
        let heartbeatInterval = null;
        let discoveryInterval = null;
        
        const DISCOVERY_CHANNEL = 'chat-room-discovery-v3';
        const HEARTBEAT_INTERVAL = 15000; // 15 Ø«Ø§Ù†ÛŒÙ‡
        const DISCOVERY_INTERVAL = 10000; // 10 Ø«Ø§Ù†ÛŒÙ‡
        
        // ==================== ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ====================
        function generateRoomCode() {
            // ØªÙˆÙ„ÛŒØ¯ ÛŒÚ© Ú©Ø¯ Ø§ØªØ§Ù‚ Û¶ Ø±Ù‚Ù…ÛŒ
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }
        
        function generateUserId(username) {
            return `${username}_${Date.now()}_${Math.random().toString(36).substr(2, 4)}`;
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'}</span>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'notificationIn 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString('fa-IR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // ==================== Ø³ÛŒØ³ØªÙ… ÙˆØ±ÙˆØ¯ Ùˆ Ø§ØªØµØ§Ù„ ====================
        async function login() {
            const usernameInput = document.getElementById('usernameInput');
            myUsername = usernameInput.value.trim();
            
            if (!myUsername || myUsername.length < 2) {
                showNotification('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            // ØªÙˆÙ„ÛŒØ¯ Ø´Ù†Ø§Ø³Ù‡ Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯
            myId = generateUserId(myUsername);
            
            // ØªÙˆÙ„ÛŒØ¯ Ú©Ø¯ Ø§ØªØ§Ù‚
            roomCode = generateRoomCode();
            
            // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage
            localStorage.setItem('chat_username', myUsername);
            localStorage.setItem('chat_room', roomCode);
            
            // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Peer
            await initializePeer();
        }
        
        async function initializePeer() {
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<div class="loading"></div> Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ...';
            
            // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø´Ù†Ø§Ø³Ù‡ ØªØ±Ú©ÛŒØ¨ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ÛŒÚ©ØªØ§ÛŒÛŒ
            const peerId = `${roomCode}_${myId}`;
            
            try {
                peer = new Peer(peerId, {
                    host: '0.peerjs.com',
                    port: 443,
                    path: '/',
                    debug: 2,
                    config: {
                        'iceServers': [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    }
                });
                
                peer.on('open', async (id) => {
                    console.log('âœ… Peer Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯:', id);
                    
                    // Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ Ú†Øª
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('chatPage').style.display = 'flex';
                    
                    // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
                    document.getElementById('roomCodeDisplay').textContent = roomCode;
                    document.getElementById('connectionStatus').textContent = 'Ø¢Ù†Ù„Ø§ÛŒÙ†';
                    
                    showNotification(`Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${myUsername}`, 'success');
                    
                    // Ø´Ø±ÙˆØ¹ Ø³ÛŒØ³ØªÙ… Ú©Ø´Ù
                    startDiscovery();
                    
                    // Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®ÙˆØ¯ Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„ Ú©Ø´Ù
                    announcePresence();
                    
                    // Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ø§ØªØµØ§Ù„Ø§Øª Ø¬Ø¯ÛŒØ¯
                    listenForConnections();
                    
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = '<span id="loginBtnText">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú†Øª Ø±ÙˆÙ…</span>';
                });
                
                peer.on('error', (err) => {
                    console.error('Ø®Ø·Ø§ÛŒ Peer:', err);
                    showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø´Ø¨Ú©Ù‡', 'error');
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = '<span id="loginBtnText">ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯</span>';
                });
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ:', error);
                showNotification('Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ…', 'error');
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<span id="loginBtnText">ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯</span>';
            }
        }
        
        // ==================== Ø³ÛŒØ³ØªÙ… Ú©Ø´Ù Ù‡ÙˆØ´Ù…Ù†Ø¯ ====================
        function startDiscovery() {
            // Ú©Ø´Ù Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± Ù‡Ù…Ø§Ù† Ø§ØªØ§Ù‚
            discoveryInterval = setInterval(() => {
                discoverPeersInRoom();
            }, DISCOVERY_INTERVAL);
            
            // Ø§Ø±Ø³Ø§Ù„ heartbeat
            heartbeatInterval = setInterval(() => {
                sendHeartbeat();
            }, HEARTBEAT_INTERVAL);
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„Ø§Øª Ø§Ø² Ø¯Ø³Øª Ø±ÙØªÙ‡
            setInterval(() => {
                checkLostConnections();
            }, 30000);
        }
        
        async function discoverPeersInRoom() {
            try {
                // 1. Ø¨Ø±Ø±Ø³ÛŒ localStorage Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
                const savedUsers = JSON.parse(localStorage.getItem(`room_${roomCode}_users`) || '[]');
                
                // 2. Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ù†Ø§Ù„ Ú©Ø´Ù Ø¹Ù…ÙˆÙ…ÛŒ
                const discoveryPeerId = `${roomCode}_discovery`;
                
                // Ø³Ø¹ÛŒ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ peer Ú©Ø´Ù
                if (!connections.has(discoveryPeerId)) {
                    try {
                        const discoveryConn = peer.connect(discoveryPeerId, {
                            reliable: true,
                            metadata: { type: 'discovery' }
                        });
                        
                        discoveryConn.on('open', () => {
                            console.log('âœ… Ø¨Ù‡ Ú©Ø§Ù†Ø§Ù„ Ú©Ø´Ù Ù…ØªØµÙ„ Ø´Ø¯ÛŒÙ…');
                            
                            // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
                            discoveryConn.send({
                                type: 'get_users',
                                from: myId,
                                username: myUsername,
                                timestamp: Date.now()
                            });
                        });
                        
                        setupConnection(discoveryConn, discoveryPeerId);
                        
                    } catch (error) {
                        // Ø§Ú¯Ø± peer Ú©Ø´Ù ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªØŒ Ù…Ø§ Ø®ÙˆØ¯Ù…Ø§Ù† Ø¢Ù† Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                        if (Math.random() < 0.3) { // 30% Ø´Ø§Ù†Ø³
                            becomeDiscoveryPeer();
                        }
                    }
                }
                
                // 3. Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
                savedUsers.forEach(user => {
                    if (user.peerId !== myId && !connections.has(user.peerId)) {
                        setTimeout(() => {
                            tryConnectToPeer(user.peerId, user.username);
                        }, Math.random() * 2000); // ØªØ§Ø®ÛŒØ± ØªØµØ§Ø¯ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² collision
                    }
                });
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ú©Ø´Ù:', error);
            }
        }
        
        function becomeDiscoveryPeer() {
            console.log('ğŸ‘‘ ØªØ¨Ø¯ÛŒÙ„ Ø´Ø¯Ù† Ø¨Ù‡ peer Ú©Ø´Ù');
            
            // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± localStorage Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
            const discoveryInfo = {
                peerId: `${roomCode}_discovery`,
                username: 'Discovery',
                timestamp: Date.now()
            };
            
            localStorage.setItem(`room_${roomCode}_discovery`, JSON.stringify(discoveryInfo));
            
            // Ø¨Ù‡ Ù‡Ù…Ù‡ Ø§Ø¹Ù„Ø§Ù… Ú©Ù† Ú©Ù‡ peer Ú©Ø´Ù Ø¬Ø¯ÛŒØ¯ÛŒ Ø¯Ø§Ø±ÛŒÙ…
            broadcastToKnownPeers({
                type: 'new_discovery',
                discoveryId: discoveryInfo.peerId,
                timestamp: Date.now()
            });
        }
        
        function announcePresence() {
            // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®ÙˆØ¯ Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†
            const userInfo = {
                peerId: peer.id,
                username: myUsername,
                roomCode: roomCode,
                timestamp: Date.now(),
                isOnline: true
            };
            
            // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage
            const roomUsers = JSON.parse(localStorage.getItem(`room_${roomCode}_users`) || '[]');
            const existingIndex = roomUsers.findIndex(u => u.peerId === peer.id);
            
            if (existingIndex >= 0) {
                roomUsers[existingIndex] = userInfo;
            } else {
                roomUsers.push(userInfo);
            }
            
            localStorage.setItem(`room_${roomCode}_users`, JSON.stringify(roomUsers));
            
            // Ø§Ø¹Ù„Ø§Ù… Ø¨Ù‡ peerÙ‡Ø§ÛŒ Ø´Ù†Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡
            broadcastToKnownPeers({
                type: 'user_announce',
                user: userInfo,
                timestamp: Date.now()
            });
        }
        
        function broadcastToKnownPeers(data) {
            connections.forEach((conn, peerId) => {
                if (conn.open && !peerId.includes('discovery')) {
                    try {
                        conn.send(data);
                    } catch (error) {
                        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡:', peerId, error);
                    }
                }
            });
        }
        
        function tryConnectToPeer(peerId, username) {
            if (connections.has(peerId) || peerId === peer.id) {
                return;
            }
            
            console.log(`ğŸ”„ ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ ${username} (${peerId})`);
            
            const conn = peer.connect(peerId, {
                reliable: true,
                metadata: {
                    type: 'direct',
                    from: myId,
                    username: myUsername
                }
            });
            
            setupConnection(conn, peerId);
            
            // timeout Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„
            setTimeout(() => {
                if (!conn.open) {
                    console.log(`â° Ø²Ù…Ø§Ù† Ø§ØªØµØ§Ù„ Ø¨Ù‡ ${peerId} Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯`);
                    conn.close();
                }
            }, 10000);
        }
        
        // ==================== Ù…Ø¯ÛŒØ±ÛŒØª Ø§ØªØµØ§Ù„Ø§Øª ====================
        function listenForConnections() {
            peer.on('connection', (conn) => {
                console.log('ğŸ”— Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§ØªØµØ§Ù„ Ø§Ø²:', conn.peer);
                setupConnection(conn, conn.peer);
            });
        }
        
        function setupConnection(conn, peerId) {
            conn.on('open', () => {
                console.log('âœ… Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯ Ø¨Ø§:', peerId);
                connections.set(peerId, conn);
                
                // Ø§Ø±Ø³Ø§Ù„ Ø³Ù„Ø§Ù…
                conn.send({
                    type: 'hello',
                    from: myId,
                    username: myUsername,
                    peerId: peer.id,
                    timestamp: Date.now()
                });
                
                // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI
                updateUsersList();
            });
            
            conn.on('data', (data) => {
                handleIncomingData(data, peerId);
            });
            
            conn.on('close', () => {
                console.log('âŒ Ø§ØªØµØ§Ù„ Ø¨Ø³ØªÙ‡ Ø´Ø¯ Ø¨Ø§:', peerId);
                connections.delete(peerId);
                
                // Ø§Ú¯Ø± peer Ú©Ø´Ù Ø¨ÙˆØ¯ØŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†
                if (peerId.includes('discovery')) {
                    setTimeout(() => discoverPeersInRoom(), 5000);
                }
                
                updateUsersList();
            });
            
            conn.on('error', (err) => {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„:', peerId, err);
                connections.delete(peerId);
                updateUsersList();
            });
        }
        
        function handleIncomingData(data, fromPeerId) {
            switch(data.type) {
                case 'hello':
                    handleHello(data, fromPeerId);
                    break;
                case 'user_announce':
                    handleUserAnnounce(data, fromPeerId);
                    break;
                case 'chat_message':
                    handleChatMessage(data, fromPeerId);
                    break;
                case 'get_users':
                    handleGetUsers(data, fromPeerId);
                    break;
                case 'users_list':
                    handleUsersList(data, fromPeerId);
                    break;
                case 'heartbeat':
                    handleHeartbeat(data, fromPeerId);
                    break;
                case 'new_discovery':
                    handleNewDiscovery(data, fromPeerId);
                    break;
            }
        }
        
        function handleHello(data, fromPeerId) {
            // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
            userDirectory.set(fromPeerId, {
                peerId: data.peerId,
                username: data.username,
                isOnline: true,
                lastSeen: Date.now()
            });
            
            // Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ø³Ù„Ø§Ù…
            const conn = connections.get(fromPeerId);
            if (conn && conn.open) {
                conn.send({
                    type: 'hello_response',
                    from: myId,
                    username: myUsername,
                    timestamp: Date.now(),
                    users: Array.from(userDirectory.values())
                });
            }
            
            // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI
            updateUsersList();
            
            showNotification(`ğŸ‘‹ ${data.username} Ø¨Ù‡ Ú†Øª Ù¾ÛŒÙˆØ³Øª`, 'success');
        }
        
        function handleUserAnnounce(data, fromPeerId) {
            const user = data.user;
            userDirectory.set(user.peerId, {
                ...user,
                lastSeen: Date.now()
            });
            
            // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage
            const roomUsers = JSON.parse(localStorage.getItem(`room_${roomCode}_users`) || '[]');
            const existingIndex = roomUsers.findIndex(u => u.peerId === user.peerId);
            
            if (existingIndex >= 0) {
                roomUsers[existingIndex] = user;
            } else {
                roomUsers.push(user);
            }
            
            localStorage.setItem(`room_${roomCode}_users`, JSON.stringify(roomUsers));
            
            // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ÛŒ Ø§Ø³ØªØŒ Ø³Ø¹ÛŒ Ú©Ù† Ø¨Ù‡ Ø§Ùˆ ÙˆØµÙ„ Ø´Ùˆ
            if (user.peerId !== peer.id && !connections.has(user.peerId)) {
                setTimeout(() => {
                    tryConnectToPeer(user.peerId, user.username);
                }, 1000);
            }
            
            updateUsersList();
        }
        
        function handleGetUsers(data, fromPeerId) {
            // Ø§Ø±Ø³Ø§Ù„ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
            const conn = connections.get(fromPeerId);
            if (conn && conn.open) {
                conn.send({
                    type: 'users_list',
                    users: Array.from(userDirectory.values()),
                    timestamp: Date.now()
                });
            }
        }
        
        function handleUsersList(data, fromPeerId) {
            // Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
            data.users.forEach(user => {
                if (user.peerId !== peer.id) {
                    userDirectory.set(user.peerId, {
                        ...user,
                        lastSeen: Date.now()
                    });
                    
                    // Ø³Ø¹ÛŒ Ø¯Ø± Ø§ØªØµØ§Ù„
                    if (!connections.has(user.peerId)) {
                        setTimeout(() => {
                            tryConnectToPeer(user.peerId, user.username);
                        }, Math.random() * 3000);
                    }
                }
            });
            
            updateUsersList();
        }
        
        function handleHeartbeat(data, fromPeerId) {
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø²Ù…Ø§Ù† Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª
            const user = userDirectory.get(fromPeerId);
            if (user) {
                user.lastSeen = Date.now();
                user.isOnline = true;
            }
        }
        
        function handleNewDiscovery(data, fromPeerId) {
            console.log('ğŸ” peer Ú©Ø´Ù Ø¬Ø¯ÛŒØ¯:', data.discoveryId);
            
            // Ø³Ø¹ÛŒ Ú©Ù† Ø¨Ù‡ peer Ú©Ø´Ù Ø¬Ø¯ÛŒØ¯ ÙˆØµÙ„ Ø´Ùˆ
            if (!connections.has(data.discoveryId)) {
                tryConnectToPeer(data.discoveryId, 'Discovery');
            }
        }
        
        function handleChatMessage(data, fromPeerId) {
            displayMessage(data, false);
        }
        
        // ==================== Ù…Ø¯ÛŒØ±ÛŒØª Ø´Ø¨Ú©Ù‡ ====================
        function sendHeartbeat() {
            connections.forEach((conn, peerId) => {
                if (conn.open) {
                    try {
                        conn.send({
                            type: 'heartbeat',
                            from: myId,
                            timestamp: Date.now()
                        });
                    } catch (error) {
                        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ heartbeat Ø¨Ù‡:', peerId);
                    }
                }
            });
        }
        
        function checkLostConnections() {
            const now = Date.now();
            let updated = false;
            
            userDirectory.forEach((user, peerId) => {
                if (now - user.lastSeen > 60000) { // 60 Ø«Ø§Ù†ÛŒÙ‡
                    user.isOnline = false;
                    updated = true;
                    
                    // Ø§Ú¯Ø± Ø§ØªØµØ§Ù„ÛŒ Ø¯Ø§Ø±ÛŒÙ…ØŒ Ø¢Ù† Ø±Ø§ Ø¨Ø¨Ù†Ø¯
                    if (connections.has(peerId)) {
                        const conn = connections.get(peerId);
                        if (conn) conn.close();
                    }
                }
            });
            
            if (updated) {
                updateUsersList();
            }
        }
        
        function refreshNetwork() {
            showNotification('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¨Ú©Ù‡...', 'info');
            
            // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø§ØªØµØ§Ù„Ø§Øª Ù‚Ø¯ÛŒÙ…ÛŒ
            connections.forEach((conn, peerId) => {
                if (!conn.open) {
                    connections.delete(peerId);
                }
            });
            
            // Ø´Ø±ÙˆØ¹ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¬Ø¯ÛŒØ¯
            discoverPeersInRoom();
            
            // Ø§Ø¹Ù„Ø§Ù… Ø­Ø¶ÙˆØ± Ù…Ø¬Ø¯Ø¯
            announcePresence();
            
            setTimeout(() => {
                showNotification('âœ… Ø´Ø¨Ú©Ù‡ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯', 'success');
            }, 2000);
        }
        
        // ==================== UI Functions ====================
        function updateUsersList() {
            const container = document.getElementById('usersList');
            container.innerHTML = '';
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø®ÙˆØ¯Ù…Ø§Ù†
            const myself = document.createElement('div');
            myself.className = 'user-badge';
            myself.innerHTML = `
                <div class="user-avatar">${myUsername.charAt(0)}</div>
                <span>${myUsername} (Ø´Ù…Ø§)</span>
                <div class="status-dot online"></div>
            `;
            container.appendChild(myself);
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯ÛŒÚ¯Ø±
            userDirectory.forEach((user, peerId) => {
                if (peerId !== myId) {
                    const userEl = document.createElement('div');
                    userEl.className = 'user-badge';
                    userEl.innerHTML = `
                        <div class="user-avatar" style="background: ${user.peerId.includes('discovery') ? '#ed8936' : '#667eea'}">
                            ${user.username.charAt(0)}
                        </div>
                        <span>${user.username}</span>
                        <div class="status-dot ${user.isOnline ? 'online' : 'offline'}"></div>
                        ${user.peerId.includes('discovery') ? '<span style="font-size: 10px; color: #ed8936;">ğŸ”</span>' : ''}
                    `;
                    container.appendChild(userEl);
                }
            });
            
            // Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø±
            const onlineCount = Array.from(userDirectory.values()).filter(u => u.isOnline).length;
            document.getElementById('connectionStatus').innerHTML = `
                ${onlineCount + 1} Ú©Ø§Ø±Ø¨Ø± Ø¢Ù†Ù„Ø§ÛŒÙ† | ${connections.size} Ø§ØªØµØ§Ù„ ÙØ¹Ø§Ù„
            `;
        }
        
        function displayMessage(data, isOutgoing) {
            const container = document.getElementById('messagesContainer');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${isOutgoing ? 'outgoing' : 'incoming'}`;
            
            messageEl.innerHTML = `
                <div class="message-header">
                    <span>${data.sender || (isOutgoing ? myUsername : 'Ú©Ø§Ø±Ø¨Ø±')}</span>
                    <span>${formatTime(data.timestamp)}</span>
                </div>
                <div class="message-content">${data.content}</div>
            `;
            
            container.appendChild(messageEl);
            container.scrollTop = container.scrollHeight;
        }
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content) return;
            
            const messageData = {
                type: 'chat_message',
                content: content,
                sender: myUsername,
                timestamp: Date.now()
            };
            
            // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯Ù…Ø§Ù†
            displayMessage(messageData, true);
            
            // Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù‡Ù…Ù‡ Ø§ØªØµØ§Ù„Ø§Øª ÙØ¹Ø§Ù„
            connections.forEach((conn, peerId) => {
                if (conn.open && !peerId.includes('discovery')) {
                    try {
                        conn.send(messageData);
                    } catch (error) {
                        console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡:', peerId);
                    }
                }
            });
            
            input.value = '';
            autoResize(input);
        }
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        function copyRoomCode() {
            navigator.clipboard.writeText(roomCode)
                .then(() => showNotification('Ú©Ø¯ Ø§ØªØ§Ù‚ Ú©Ù¾ÛŒ Ø´Ø¯', 'success'))
                .catch(() => showNotification('Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù†', 'error'));
        }
        
        function showRoomCode() {
            const usernameInput = document.getElementById('usernameInput');
            const username = usernameInput.value.trim();
            
            if (!username) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            const code = generateRoomCode();
            alert(`Ú©Ø¯ Ø§ØªØ§Ù‚ Ø´Ù…Ø§:\n\n${code}\n\nØ§ÛŒÙ† Ú©Ø¯ Ø±Ø§ Ø¨Ù‡ Ø¯ÙˆØ³ØªØ§Ù† Ø®ÙˆØ¯ Ø¨Ø¯Ù‡ÛŒØ¯ ØªØ§ Ø¨Ù‡ Ø§ØªØ§Ù‚ Ø´Ù…Ø§ Ø¨Ù¾ÛŒÙˆÙ†Ø¯Ù†Ø¯.`);
            
            // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± input
            localStorage.setItem('temp_room_code', code);
        }
        
        function leaveChat() {
            if (confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø² Ú†Øª Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ØŸ')) {
                // Ø¨Ø³ØªÙ† Ù‡Ù…Ù‡ Ø§ØªØµØ§Ù„Ø§Øª
                connections.forEach(conn => conn.close());
                connections.clear();
                
                // ØªÙˆÙ‚Ù intervalÙ‡Ø§
                if (heartbeatInterval) clearInterval(heartbeatInterval);
                if (discoveryInterval) clearInterval(discoveryInterval);
                
                // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯
                document.getElementById('loginPage').style.display = 'block';
                document.getElementById('chatPage').style.display = 'none';
                
                showNotification('Ø§Ø² Ú†Øª Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯', 'info');
            }
        }
        
        function resetAllData() {
            if (confirm('âš ï¸ Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø§Ú© Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯. Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                localStorage.clear();
                location.reload();
            }
        }
        
        // ==================== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
            const savedUsername = localStorage.getItem('chat_username');
            const savedRoom = localStorage.getItem('chat_room');
            
            if (savedUsername) {
                document.getElementById('usernameInput').value = savedUsername;
            }
            
            // Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø¯Ø± Ø§ØªØ§Ù‚ÛŒ Ø¨ÙˆØ¯ÛŒÙ…ØŒ Ø³Ø¹ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ÙˆØµÙ„ Ø´ÙˆÛŒÙ…
            if (savedUsername && savedRoom) {
                const tempRoom = localStorage.getItem('temp_room_code');
                if (tempRoom) {
                    roomCode = tempRoom;
                    localStorage.removeItem('temp_room_code');
                    login();
                }
            }
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¨Ø±Ø§ÛŒ Ø²ÛŒØ¨Ø§ÛŒÛŒ
            const loginInput = document.getElementById('usernameInput');
            loginInput.focus();
        });
    </script>
</body>
</html>
